<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Cybersecurity Project: Windows Defender Firewall STIG Script - XS Tech Thoughts</title><meta name="description" content="Explore the diverse portfolio of a multi-talented professional with experience in cybersecurity, UX/UI design, writing, and video game modding."><meta name="generator" content="Publii Open-Source CMS for Static Site"><!-- Global site tag (gtag.js) - Google Analytics --><script type="gdpr-blocker/Analytics" async src="https://www.googletagmanager.com/gtag/js?id=G-EHLH28GQMY"></script><script type="gdpr-blocker/Analytics">window.dataLayer = window.dataLayer || [];
				  function gtag(){dataLayer.push(arguments);}
				  gtag('js', new Date());
				  gtag('config', 'G-EHLH28GQMY' , { 'anonymize_ip': true });
				  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EHLH28GQMY"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EHLH28GQMY');</script><link rel="stylesheet" href="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-black.css"><link rel="stylesheet" href="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-inline-color.css"><link rel="canonical" href="https://korgano.github.io/cybersecurity-project-windows-defender-firewall-stig-script/"><link rel="alternate" type="application/atom+xml" href="https://korgano.github.io/feed.xml"><meta property="og:title" content="Cybersecurity Project: Windows Defender Firewall STIG Script"><meta property="og:image" content="https://korgano.github.io/media/posts/36/VirtualBox_Win11-Ent-IOT_29_03_2025_11_25_42-2.png"><meta property="og:image:width" content="1024"><meta property="og:image:height" content="768"><meta property="og:site_name" content="XS Tech Thoughts"><meta property="og:description" content="Explore the diverse portfolio of a multi-talented professional with experience in cybersecurity, UX/UI design, writing, and video game modding."><meta property="og:url" content="https://korgano.github.io//cybersecurity-project-windows-defender-firewall-stig-script/"><meta property="og:type" content="article"><link rel="preload" href="https://korgano.github.io/assets/dynamic/fonts/robotoflex/robotoflex.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="https://korgano.github.io/assets/dynamic/fonts/robotoslab/robotoslab.woff2" as="font" type="font/woff2" crossorigin><link rel="stylesheet" href="https://korgano.github.io/assets/css/style.css?v=338ed96ce9bc0f6c72a02763a377a303"><link rel="stylesheet" href="https://korgano.github.io/assets/css/photoswipe.css?v=da6e9be0fa855edd3610e97c1d4e38d9"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://korgano.github.io/cybersecurity-project-windows-defender-firewall-stig-script/"},"headline":"Cybersecurity Project: Windows Defender Firewall STIG Script","datePublished":"2025-03-31T10:03-04:00","dateModified":"2025-04-01T16:06-04:00","image":{"@type":"ImageObject","url":"https://korgano.github.io/media/posts/36/VirtualBox_Win11-Ent-IOT_29_03_2025_11_25_42-2.png","height":768,"width":1024},"description":"Explore the diverse portfolio of a multi-talented professional with experience in cybersecurity, UX/UI design, writing, and video game modding.","author":{"@type":"Person","name":"Xavier Santana","url":"https://korgano.github.io/authors/xavier-santana/"},"publisher":{"@type":"Organization","name":"Xavier Santana"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="post-template lines"><div class="container lines lines--right"><header class="header"><a href="https://korgano.github.io/" class="logo">XS Tech Thoughts</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu">Menu</button><ul class="navbar__menu"><li><a href="https://korgano.github.io/" title="Home" target="_self">Home</a></li><li><a href="https://korgano.github.io/tags/uxui-case-study/" title="UX/UI Case Studies" target="_blank">UX/UI Case Studies</a></li><li><a href="https://korgano.github.io/tags/cybersecurity-projects/" title="Cybersecurity Projects" target="_blank">Cybersecurity Projects</a></li><li><a href="https://korgano.github.io/tags/quick-thoughts/" title="Quick Thoughts" target="_self">Quick Thoughts</a></li><li><a href="https://korgano.github.io/about-me/" title="About Me" target="_blank">About Me</a></li></ul></nav></header><main class="main post"><article class="content"><header class="content__inner content__header"><h1 class="content__title">Cybersecurity Project: Windows Defender Firewall STIG Script</h1><div class="content__meta"><div class="content__meta__left"><a href="https://korgano.github.io/authors/xavier-santana/" class="invert content__author" rel="author" title="Xavier Santana">Xavier Santana</a></div><div class="content__meta__right"><time datetime="2025-03-31T10:03" class="content__date">March 31, 2025</time><div class="content__updated">Updated on <time datetime="2025-03-31T10:03" class="content__date">April 1, 2025</time></div></div></div></header><figure class="content__featured-image"><div class="content__featured-image__inner is-img-loading"><img src="https://korgano.github.io/media/posts/36/VirtualBox_Win11-Ent-IOT_29_03_2025_11_25_42-2.png" srcset="https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_25_42-2-xs.png 384w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_25_42-2-sm.png 600w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_25_42-2-md.png 768w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_25_42-2-lg.png 1200w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_25_42-2-xl.png 1600w" sizes="(min-width: 37.5em) 1600px, 80vw" loading="eager" height="768" width="1024" alt="Default Windows Defender Firewall settings on Windows 11 Enterprise IOT LTSC: Firewall on in all domains, inbound connections blocked by default, outbound connections allowed by default."></div></figure><div class="content__inner"><div class="content__entry"><p>Having focused a lot on networking and AI implications for security lately, I've decided to pivot into something a little different, but still connected: Compliance.</p><p>The Defense Information Systems Agency (DISA) provides unclassified Security Technical Implementation Guides (STIGs) for hardening specific systems. For those whoÂ <strong>don'tÂ </strong>want to go on a government monitored system, <a href="https://stigviewer.com/" title="DISA STIG Viewer" target="_blank" rel="noopener noreferrer">DISA STIG Viewer</a> is a good option to check these guides out.</p><p>I decided to make a script that would do two main things:</p><ol><li>Check the status of the system regarding the controls/settings.</li><li>Â </li><li>Update the settings/implement the controls.</li></ol><div class="post__toc"><h3>Table of Contents</h3><ul><li><a href="#mcetoc_1inma3p0pa">Picking a STIG</a></li><li>Â </li></ul></div><h2 id="mcetoc_1inma3p0pa">Picking a STIG</h2><p>Given the number of STIGs, one might be overwhelmed and get into decision paralysis.</p><p>However, I used a simple metric to cutdown the number of choices: Did I have the software/hardware in use on a system I used? This was because I wanted to implement the STIGs across all the systems I used and maintained.</p><p>This reduced the options to 4:</p><ol><li>Windows 10</li><li>Windows 11</li><li>Firefox</li><li>Windows Defender Firewall</li></ol><p>From there, I then picked the one with the smallest number of controls to implement: Windows Defender Firewall.</p><h2>Making the Script</h2><p>The next step was to make the script.</p><p>I chose to utilize AI, namely ChatGPT, for this, for a few reasons:</p><ol><li>I wanted to save time in creating the script.</li><li>It allows for faster iteration.</li><li>If the process worked, I could then apply it to other STIGs.</li></ol><p>To do this, I examined the STIG's CSV file, where all the controls and their requirements are enumerated. What I discovered for the <a href="https://stigviewer.com/stigs/microsoft_windows_defender_firewall_with_advanced_security" title="Microsoft Windows Defender Firewall with Advanced Security Security Technical Implementation Guide" target="_blank" rel="noopener noreferrer">Windows Firewall STIG</a> was not a well ordered spreadsheet. Instead, it seemed more like a standard page, laid out in numerous rows, in a single column format.</p><p>Cross checking with the CSVs for some of the other STIGs revealed this to be simply this specific STIG's format.</p><p>That led me to write a prompt that laid out the specifics of what I wanted done, instead of uploading the CSV and then referring to it in the prompt. That prompt is available <a href="https://github.com/korgano/WinDefender-Firewall-STIG-Validator/blob/main/Prompts/WinFirewall-STIG-Prompt.txt" title="WinFirewall-STIG-Prompt.txt" target="_blank" rel="noopener noreferrer">here</a>, on a GitHub repo that contains the prompts and the generated scripts.</p><p>The process took a few hours, mostly because I would get confused at times, due to how similar and repetitive many elements of the tasks were. I implemented all but one of the STIG controls, with the final control being omitted due to the lack of a remote management connection.</p><h2>The First Iteration</h2><p>After the hard work of crafting the prompt was done, the first iteration of the script was generated (<a href="https://github.com/korgano/WinDefender-Firewall-STIG-Validator/blob/main/PastIterations/WinFirewall-STIG-tester-v1.ps1" title="WinFirewall-STIG-tester-v1.ps1 on GitHub" target="_blank" rel="noopener noreferrer">code here</a>). Since downloading the Windows image was taking a while (more on that later), this iteration was tested on a live Windows 10 system. (Said system had nothing of real value, and could've really used the excuse to be upgraded.)</p><p>The script ran its functions properly, but the CSV output generated revealed I had made an understandable oversight. There were no descriptions to explain what the actual controls were doing, just ID numbers.</p><h2>Iterations 2 &amp; 3</h2><p>Curious to see how the script would be changed, I gave ChatGPT <a href="https://github.com/korgano/WinDefender-Firewall-STIG-Validator/blob/main/Prompts/Add-Descriptions-Prompt.txt" title="Add-Descriptions-Prompt.txt" target="_blank" rel="noopener noreferrer">this follow up prompt</a>. This generated the second iteration, which had the following code added to the existing script:</p><blockquote><p><code># Mapping of Findings to their Descriptions</code><br><code>$descriptions = @{</code><br><code>Â  Â  "V-241989" = "Windows Defender Firewall must be enabled when connected to a domain."</code><br><code>Â  Â  "V-241990" = "Windows Defender Firewall must be enabled when connected to a private network."</code><br><code>Â  Â  "V-241991" = "Windows Defender Firewall must be enabled when connected to a public network."</code><br><code>Â  Â  "V-241992" = "Windows Defender Firewall must block unsolicited inbound connections when connected to a domain."</code><br><code>Â  Â  "V-241993" = "Windows Defender Firewall must allow outbound connections, unless explicitly blocked by rule."</code><br><code>Â  Â  "V-241994" = "Windows Defender Firewall log size must be configured for domain connections."</code><br><code>Â  Â  "V-241995" = "Windows Defender Firewall must log dropped packets when connected to a domain."</code><br><code>Â  Â  "V-241996" = "Windows Defender Firewall must log successful connections when connected to a domain."</code><br><code>Â  Â  "V-241997" = "Windows Defender Firewall must block unsolicited inbound connections when connected to a private network."</code><br><code>Â  Â  "V-241998" = "Windows Defender Firewall must allow outbound connections on a private network, unless explicitly blocked by rule."</code><br><code>Â  Â  "V-241999" = "Windows Defender Firewall log size must be configured for private network connections."</code><br><code>Â  Â  "V-242000" = "Windows Defender Firewall must log dropped packets when connected to a private network."</code><br><code>Â  Â  "V-242001" = "Windows Defender Firewall must log successful connections when connected to a private network."</code><br><code>Â  Â  "V-242002" = "Windows Defender Firewall must block unsolicited inbound connections when connected to a public network."</code><br><code>Â  Â  "V-242003" = "Windows Defender Firewall must allow outbound connections on a public network, unless explicitly blocked by rule."</code><br><code>Â  Â  "V-242004" = "Windows Defender Firewall public network connections must not merge local firewall rules with Group policy settings."</code><br><code>Â  Â  "V-242005" = "Windows Defender Firewall public network connections must not merge local connection rules with Group policy settings."</code><br><code>Â  Â  "V-242006" = "Windows Defender Firewall log size must be configured for public connections."</code><br><code>Â  Â  "V-242007" = "Windows Defender Firewall must log dropped packets when connected to a public network."</code><br><code>Â  Â  "V-242008" = "Windows Defender Firewall must log successful connections when connected to a public network."</code><br><code>}</code></p></blockquote><p>Based on my admittedly shoddy understanding of programming/coding best practices, this is basically creating an array that stores the variables associated with the actual descriptions.</p><p>This is presumably more efficient than just doing a brute force, manual addition of a field called <code>Description</code> to each row, and then putting in the string of text.</p><p>This didn't address any issues with the log identifying things by row numbers instead of the finding numbers, but that was easily dealt with in the third iteration. All it took was editing the code in VS Code.</p><h2>Testing in Windows 11 Enterprise IOT LTSC</h2><figure class="post__video"><iframe loading="lazy" width="560" height="314" src="https://www.youtube-nocookie.com/embed/iu0Ob0HBFNo" allowfullscreen="allowfullscreen" data-mce-fragment="1"></iframe></figure><p>The choice of Windows 11 Enterprise IOT LTSC came about after I decided to do some verification on the Windows 10 test system after generating the second iteration.</p><p>It turned out that even settings like the firewall log size are so locked down on Windows Home editions that the commands have no actual effect. Inputting the specific commands into an administrator command prompt yields an "Access is denied." response.</p><p>(The reader is free to speculate as to the reasoning for this.)</p><p>Actually downloading the image took an annoying amount of time, as the website hosting the non-trial images does not work well with browser download managers. A separate download manager is required, and if you don't use Edge, it can be hard to get the download link for the ISO.</p><p>Once the virtual machine was ready, I made a snapshot of the initial configuration, and checked the defaults:</p><figure class="post__image"><img loading="lazy" src="https://korgano.github.io/media/posts/36/VirtualBox_Win11-Ent-IOT_29_03_2025_11_25_42.png" alt="Default Windows Defender Firewall settings on Windows 11 Enterprise IOT LTSC: Firewall on in all domains, inbound connections blocked by default, outbound connections allowed by default." width="1024" height="768" sizes="(min-width: 37.5em) 1600px, 80vw" srcset="https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_25_42-xs.png 384w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_25_42-sm.png 600w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_25_42-md.png 768w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_25_42-lg.png 1200w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_25_42-xl.png 1600w"></figure><p>To verify that Enterprise IOT LTSC wasÂ <strong>not</strong> as locked down as the Home version, I checked if I could change the logging settings:</p><figure class="post__image"><img loading="lazy" src="https://korgano.github.io/media/posts/36/VirtualBox_Win11-Ent-IOT_29_03_2025_11_26_42.png" alt="Verifying Windows 11 Enterprise IOT LTSC firewall setting freedom by changing Log Dropped Packages to &quot;Yes&quot; from &quot;No (Default)&quot;." width="1024" height="768" sizes="(min-width: 37.5em) 1600px, 80vw" srcset="https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_26_42-xs.png 384w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_26_42-sm.png 600w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_26_42-md.png 768w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_26_42-lg.png 1200w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_26_42-xl.png 1600w"></figure><p>With that confirmed, I ran the third iteration of the script:</p><div class="gallery-wrapper"><div class="gallery" data-is-empty="false" data-translation="Add images" data-columns="4"><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_44_39.png" data-size="1024x768"><img loading="lazy" src="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_44_39-thumbnail.png" alt="Logged actions of the script." width="768" height="576"></a></figure><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_46_07.png" data-size="1024x768"><img loading="lazy" src="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_46_07-thumbnail.png" alt="Domain Profile rules merging being unchanged." width="768" height="576"></a></figure><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_46_26.png" data-size="1024x768"><img loading="lazy" src="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_46_26-thumbnail.png" alt="Updated Domain Profile logging settings." width="768" height="576"></a></figure><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_46_52.png" data-size="1024x768"><img loading="lazy" src="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_46_52-thumbnail.png" alt="Private Profile rules merging being unchanged." width="768" height="576"></a></figure><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_47_02.png" data-size="1024x768"><img loading="lazy" src="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_47_02-thumbnail.png" alt="Updated Private Profile logging settings." width="768" height="576"></a></figure><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_47_23.png" data-size="1024x768"><img loading="lazy" src="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_47_23-thumbnail.png" alt="Public Profile rules merging being unchanged." width="768" height="576"></a></figure><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_47_35.png" data-size="1024x768"><img loading="lazy" src="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_47_35-thumbnail.png" alt="Updated Public Profile logging settings." width="768" height="576"></a></figure></div></div><p>For whatever reason, attempting to change the rules merging settings failed. So I decided to look at the registry:</p><figure class="post__image"><img loading="lazy" src="https://korgano.github.io/media/posts/36/VirtualBox_Win11-Ent-IOT_29_03_2025_11_52_02.png" alt="Looking for the HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile\ entry in the Windows 11 Enterprise IOT LTSC registry." width="1024" height="768" sizes="(min-width: 37.5em) 1600px, 80vw" srcset="https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_52_02-xs.png 384w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_52_02-sm.png 600w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_52_02-md.png 768w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_52_02-lg.png 1200w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_29_03_2025_11_52_02-xl.png 1600w"></figure><p>V-242004 of the Windows Firewall STIG says that the following should be present:</p><blockquote><p>Registry Hive: HKEY_LOCAL_MACHINE<br>Registry Path: \SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile\</p></blockquote><p>It was not, and it's not entirely clear why. Since the Windows Defender Firewall STIG was last updated in August 2023, it's entirely possible that entire setting has been depreciated by Microsoft, or made useless without an actual Group Policy.</p><div class="gallery-wrapper"><div class="gallery" data-is-empty="false" data-translation="Add images" data-columns="3"><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_53_55.png" data-size="1024x768"><img loading="lazy" src="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_53_55-thumbnail.png" alt="Public Profile registry entries in Windows 11 Enterprise IOT LTSC." width="768" height="576"></a></figure><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_54_17.png" data-size="1024x768"><img loading="lazy" src="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_54_17-thumbnail.png" alt="Domain Profile registry entries in Windows 11 Enterprise IOT LTSC." width="768" height="576"></a></figure><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_54_39.png" data-size="1024x768"><img loading="lazy" src="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_29_03_2025_11_54_39-thumbnail.png" alt="Private Profile registry entries in Windows 11 Enterprise IOT LTSC." width="768" height="576"></a></figure></div></div><p>The <code>CurrentControlSet</code> registry entries for the various profilesÂ <strong>didÂ </strong>exist, which was why those settings could be correctly updated.</p><h2>Iteration 4 &amp; 5</h2><p>To add an extra level of confidence to the results of the script, I decided to add a validation pass with <a href="https://github.com/korgano/WinDefender-Firewall-STIG-Validator/blob/main/Prompts/Add-Validation-Prompt.txt" title="Add-Validation-Prompt.txt" target="_blank" rel="noopener noreferrer">the following prompt</a>:</p><blockquote><p>Update script to do the following:<br>-Log if command has been granted permissions to execute<br>-Validate that the settings have been properly updated<br>-If settings have not been properly updated, set corrected value to False, and log correction failure</p></blockquote><p>I then ran <a href="https://github.com/korgano/WinDefender-Firewall-STIG-Validator/blob/main/PastIterations/WinFirewall-STIG-tester-v4.ps1" title="WinFirewall-STIG-tester-v4.ps1" target="_blank" rel="noopener noreferrer">this iteration of the script</a> on a modified snapshot of initial install, with the full Guest Additions package installed. This was the result:</p><figure class="post__image"><img loading="lazy" src="https://korgano.github.io/media/posts/36/VirtualBox_Win11-Ent-IOT_01_04_2025_10_07_59.png" alt="Log output of WinFirewall-STIG-tester-v4 with false negative readings for the connection logging findings." width="1024" height="768" sizes="(min-width: 37.5em) 1600px, 80vw" srcset="https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_01_04_2025_10_07_59-xs.png 384w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_01_04_2025_10_07_59-sm.png 600w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_01_04_2025_10_07_59-md.png 768w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_01_04_2025_10_07_59-lg.png 1200w, https://korgano.github.io/media/posts/36/responsive/VirtualBox_Win11-Ent-IOT_01_04_2025_10_07_59-xl.png 1600w"></figure><p>Oddly enough, all the validation checks for the connection logging settings failed. So I examined the actual settings through the GUI:</p><div class="gallery-wrapper"><div class="gallery" data-is-empty="false" data-translation="Add images" data-columns="3"><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_01_04_2025_10_08_42.png" data-size="1024x768"><img loading="lazy" src="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_01_04_2025_10_08_42-thumbnail.png" alt="Domain Profile with logging enabled for dropped and successful connections." width="768" height="576"></a></figure><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_01_04_2025_10_09_08.png" data-size="1024x768"><img loading="lazy" src="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_01_04_2025_10_09_08-thumbnail.png" alt="Private Profile with logging enabled for dropped and successful connections." width="768" height="576"></a></figure><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_01_04_2025_10_09_21.png" data-size="1024x768"><img loading="lazy" src="https://korgano.github.io/media/posts/36/gallery/VirtualBox_Win11-Ent-IOT_01_04_2025_10_09_21-thumbnail.png" alt="Public Profile with logging enabled for dropped and successful connections." width="768" height="576"></a></figure></div></div><p>Since the system reported that the settingsÂ <strong>hadÂ </strong>been configured correctly, that pointed to an error in the script.</p><p>Opening up the Registry Editor and searching for the name <code>LogDroppedPackets</code> revealed that I had made the following error in the original prompt:</p><blockquote><p><code>Incorrect: "HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile",</code><br><code>Incorrect: "HKLM:\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\DomainProfile"</code></p><p><code>Correct: "HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging",</code><br><code>Correct: "HKLM:\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\DomainProfile\Logging"</code></p></blockquote><p>As a result, the script was checking the wrong area in the registry, finding no registry entry for <code>LogDroppedPackets</code> or <code>LogSuccessfulConnections</code>, and declaring that the correction had failed. In essence, the quintessential false negative.</p><p>This was easily corrected in <a href="https://github.com/korgano/WinDefender-Firewall-STIG-Validator/blob/main/WinFirewall-STIG-tester-v5.ps1" title="WinFirewall-STIG-tester-v5.ps1" target="_blank" rel="noopener noreferrer">the fifth iteration</a> by amending the paths.</p><h2>Takeaways</h2><ul><li>DISA STIG Viewer is a great resource for anyone looking to understand DOD compliance or looking for a guide on how to harden their systems.</li><li>STIG Viewer's CSVs for a particular STIG may not be correctly formatted.</li><li>For smaller STIGs, handcrafting prompts instead of uploading a CSV for AI code generation is possible, but runs the risk of errors in the code.</li><li>Including a validation test is a good way to spot errors in output.</li><li>Using reasoning LLMs to iteratively update code is quite effective if the user knows how to articulate what their objective is.</li><li>Windows 11 Home gives the user far less ability to fine tune security controls with its implementation of Windows Defender Firewall.</li></ul><h2 id="mcetoc_1inma2kuk5"></h2></div><footer class="content__footer"><div class="content__tag-share"><div class="content__tag"><h3 class="content__tag__title">Posted in</h3><ul class="content__tag__list"><li><a href="https://korgano.github.io/tags/ai/">AI</a></li><li><a href="https://korgano.github.io/tags/cybersecurity/">Cybersecurity</a></li><li><a href="https://korgano.github.io/tags/cybersecurity-projects/">Cybersecurity Projects</a></li><li><a href="https://korgano.github.io/tags/pc/">PC</a></li><li><a href="https://korgano.github.io/tags/tech/">Tech</a></li></ul></div><div class="content__share"><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fkorgano.github.io%2Fcybersecurity-project-windows-defender-firewall-stig-script%2F" class="js-share linkedin" aria-label="Share with LinkedIn" rel="nofollow noopener noreferrer"><svg><use xlink:href="https://korgano.github.io/assets/svg/svg-map.svg#linkedin"/></svg></a></div></div></footer></div></article><div class="content__related"><h3 class="content__related__title">Related posts</h3><div class="l-grid l-grid--2"><article class="c-card"><div class="c-card__wrapper"><figure class="c-card__image is-img-loading"><img src="https://korgano.github.io/media/posts/10/glenn-carstens-peters-npxXWgQ33ZQ-unsplash.jpg" srcset="https://korgano.github.io/media/posts/10/responsive/glenn-carstens-peters-npxXWgQ33ZQ-unsplash-xs.jpg 384w, https://korgano.github.io/media/posts/10/responsive/glenn-carstens-peters-npxXWgQ33ZQ-unsplash-sm.jpg 600w, https://korgano.github.io/media/posts/10/responsive/glenn-carstens-peters-npxXWgQ33ZQ-unsplash-md.jpg 768w, https://korgano.github.io/media/posts/10/responsive/glenn-carstens-peters-npxXWgQ33ZQ-unsplash-lg.jpg 1200w" sizes="(min-width: 37.5em) 80vw, 50vw" loading="lazy" height="2712" width="4076" alt=""></figure><div class="c-card__content"><header><h2 class="c-card__title"><a href="https://korgano.github.io/cybersecurity-project-research-remote-access/" class="invert">Cybersecurity Project Research: Remote Access</a></h2></header><footer class="c-card__meta"><a href="https://korgano.github.io/tags/cybersecurity-projects/" class="c-card__tag">Cybersecurity Projects</a></footer></div></div></article><article class="c-card"><div class="c-card__wrapper"><figure class="c-card__image is-img-loading"><img src="https://korgano.github.io/media/posts/9/andres-urena-vXPXRp_wIg4-unsplash.jpg" srcset="https://korgano.github.io/media/posts/9/responsive/andres-urena-vXPXRp_wIg4-unsplash-xs.jpg 384w, https://korgano.github.io/media/posts/9/responsive/andres-urena-vXPXRp_wIg4-unsplash-sm.jpg 600w, https://korgano.github.io/media/posts/9/responsive/andres-urena-vXPXRp_wIg4-unsplash-md.jpg 768w, https://korgano.github.io/media/posts/9/responsive/andres-urena-vXPXRp_wIg4-unsplash-lg.jpg 1200w" sizes="(min-width: 37.5em) 80vw, 50vw" loading="lazy" height="1687" width="3000" alt=""></figure><div class="c-card__content"><header><h2 class="c-card__title"><a href="https://korgano.github.io/cybersecurity-headache-home-router-uxui/" class="invert">Cybersecurity Headache: Home Router UXUI</a></h2></header><footer class="c-card__meta"><a href="https://korgano.github.io/tags/quick-thoughts/" class="c-card__tag">Quick Thoughts</a></footer></div></div></article></div></div></main><footer class="footer"><div class="footer__left"><div class="footer__copy">Copyright Xavier Santana, 2023-2024. Powered by Publii.</div></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg><use xlink:href="https://korgano.github.io/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = { mobileMenuMode: 'sidebar', animationSpeed: 300, submenuWidth: 'auto', doubleClickTime: 500, mobileMenuExpandableSubmenus: true, relatedContainerForOverlayMenuSelector: '.navbar', };</script><script defer="defer" src="https://korgano.github.io/assets/js/scripts.min.js?v=9c5ab7a87221183f149a42b3cceb7956"></script><script>function publiiDetectLoadedImages () {
         var images = document.querySelectorAll('img[loading]:not(.is-loaded)');
         for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
               images[i].classList.add('is-loaded');
               images[i].parentNode.classList.remove('is-img-loading');
            } else {
               images[i].addEventListener('load', function () {
                  this.classList.add('is-loaded');
                  this.parentNode.classList.remove('is-img-loading');
               }, false);
            }
         }
      }
      publiiDetectLoadedImages();</script><script defer="defer" src="https://korgano.github.io/assets/js/photoswipe.min.js?v=017385b552f7e0d979e2e2fe6f324015"></script><script defer="defer" src="https://korgano.github.io/assets/js/photoswipe-ui-default.min.js?v=d067f0883540b1ddda0e2c9ad1b14260"></script><script>var initPhotoSwipeFromDOM=function(gallerySelector){var parseThumbnailElements=function(el){var thumbElements=el.childNodes,numNodes=thumbElements.length,items=[],figureEl,linkEl,size,item;for(var i=0;i<numNodes;i++){figureEl=thumbElements[i];if(figureEl.nodeType!==1){continue;}
   linkEl=figureEl.children[0];size=linkEl.getAttribute('data-size').split('x');item={src:linkEl.getAttribute('href'),w:parseInt(size[0],10),h:parseInt(size[1],10)};if(figureEl.children.length>1){item.title=figureEl.children[1].innerHTML;}
   if(linkEl.children.length>0){item.msrc=linkEl.children[0].getAttribute('src');}
   item.el=figureEl;items.push(item);}
   return items;};var closest=function closest(el,fn){return el&&(fn(el)?el:closest(el.parentNode,fn));};var onThumbnailsClick=function(e){e=e||window.event;e.preventDefault?e.preventDefault():e.returnValue=false;var eTarget=e.target||e.srcElement;var clickedListItem=closest(eTarget,function(el){return(el.tagName&&el.tagName.toUpperCase()==='FIGURE');});if(!clickedListItem){return;}
   var clickedGallery=clickedListItem.parentNode,childNodes=clickedListItem.parentNode.childNodes,numChildNodes=childNodes.length,nodeIndex=0,index;for(var i=0;i<numChildNodes;i++){if(childNodes[i].nodeType!==1){continue;}
   if(childNodes[i]===clickedListItem){index=nodeIndex;break;}
   nodeIndex++;}
   if(index>=0){openPhotoSwipe(index,clickedGallery);}
   return false;};var photoswipeParseHash=function(){var hash=window.location.hash.substring(1),params={};if(hash.length<5){return params;}
   var vars=hash.split('&');for(var i=0;i<vars.length;i++){if(!vars[i]){continue;}
   var pair=vars[i].split('=');if(pair.length<2){continue;}
   params[pair[0]]=pair[1];}
   if(params.gid){params.gid=parseInt(params.gid,10);}
   return params;};var openPhotoSwipe=function(index,galleryElement,disableAnimation,fromURL){var pswpElement=document.querySelectorAll('.pswp')[0],gallery,options,items;items=parseThumbnailElements(galleryElement);options={galleryUID:galleryElement.getAttribute('data-pswp-uid'),getThumbBoundsFn:function(index){var thumbnail=items[index].el.getElementsByTagName('img')[0],pageYScroll=window.pageYOffset||document.documentElement.scrollTop,rect=thumbnail.getBoundingClientRect();return{x:rect.left,y:rect.top+pageYScroll,w:rect.width};},
   mainClass:'pswp--dark',
   preload: [1,2],
   hideAnimationDuration:200,
   showAnimationDuration:0,
   bgOpacity: 0.7,
   showHideOpacity:true,
   closeOnScroll: true,
   arrowKeys: true,
   closeEl: true,
   captionEl: true,
   fullscreenEl: true,
   zoomEl: true,
   shareEl: true,
   counterEl: true,
   arrowEl: true,
   preloaderEl: true
   };if(fromURL){if(options.galleryPIDs){for(var j=0;j<items.length;j++){if(items[j].pid==index){options.index=j;break;}}}else{options.index=parseInt(index,10)-1;}}else{options.index=parseInt(index,10);}
   if(isNaN(options.index)){return;}
   if(disableAnimation){options.showAnimationDuration=0;}
   gallery=new PhotoSwipe(pswpElement,PhotoSwipeUI_Default,items,options);gallery.init();gallery.options.escKey=true;};var galleryElements=document.querySelectorAll(gallerySelector);for(var i=0,l=galleryElements.length;i<l;i++){galleryElements[i].setAttribute('data-pswp-uid',i+1);galleryElements[i].onclick=onThumbnailsClick;}
   var hashData=photoswipeParseHash();if(hashData.pid&&hashData.gid){openPhotoSwipe(hashData.pid,galleryElements[hashData.gid-1],true,true);}};window.addEventListener('load', function () {initPhotoSwipeFromDOM('.gallery');}, false);</script><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button><button class="pswp__button pswp__button--share" title="Share"></button><button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button><button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button><button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/prism.js"></script><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-line-numbers.min.js"></script><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/clipboard.min.js"></script><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-copy-to-clipboard.min.js"></script><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-inline-color.min.js"></script><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-show-invisibles.min.js"></script><!-- Start main cookie container --><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><!-- Start Banner --><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site, for marketing, and to provide social media functionality. <a href="https://korgano.github.io/privacy-policy/">More details...</a></div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><!-- End of Banner --><!-- Badge --> <button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button><!-- End of Badge --></div><!-- End of main cookie container --><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('ðŸª Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('ðŸª GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('ðŸª Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('ðŸª GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('ðŸª Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && cbConfig.initialLsState.indexOf(allowedGroup) === -1) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('ðŸª GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('ðŸª Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('ðŸª Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('ðŸª Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('ðŸª Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>