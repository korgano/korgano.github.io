<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>CyberSecurity Project: Transparent Filtering Bridge (+ Extras) 9.0 - XS Tech Thoughts</title><meta name="description" content="Xavier Santana conducts cybersecurity analysis of data gathered by transparent filtering bridge on his home network, discovering malicious Chinese activity."><meta name="generator" content="Publii Open-Source CMS for Static Site"><!-- Global site tag (gtag.js) - Google Analytics --><script type="gdpr-blocker/Analytics" async src="https://www.googletagmanager.com/gtag/js?id=G-EHLH28GQMY"></script><script type="gdpr-blocker/Analytics">window.dataLayer = window.dataLayer || [];
				  function gtag(){dataLayer.push(arguments);}
				  gtag('js', new Date());
				  gtag('config', 'G-EHLH28GQMY' , { 'anonymize_ip': true });
				  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EHLH28GQMY"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EHLH28GQMY');</script><link rel="stylesheet" href="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-black.css"><link rel="stylesheet" href="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-inline-color.css"><link rel="canonical" href="https://korgano.github.io/cybersecurity-project-transparent-filtering-bridge-extras-90/"><link rel="alternate" type="application/atom+xml" href="https://korgano.github.io/feed.xml" title="XS Tech Thoughts - RSS"><meta property="og:title" content="CyberSecurity Project: Transparent Filtering Bridge (+ Extras) 9.0"><meta property="og:image" content="https://korgano.github.io/media/posts/42/cyber-proj-tfb15.png"><meta property="og:image:width" content="1920"><meta property="og:image:height" content="921"><meta property="og:site_name" content="XS Tech Thoughts"><meta property="og:description" content="Xavier Santana conducts cybersecurity analysis of data gathered by transparent filtering bridge on his home network, discovering malicious Chinese activity."><meta property="og:url" content="https://korgano.github.io/cybersecurity-project-transparent-filtering-bridge-extras-90/"><meta property="og:type" content="article"><link rel="preload" href="https://korgano.github.io/assets/dynamic/fonts/robotoflex/robotoflex.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="https://korgano.github.io/assets/dynamic/fonts/robotoslab/robotoslab.woff2" as="font" type="font/woff2" crossorigin><link rel="stylesheet" href="https://korgano.github.io/assets/css/style.css?v=253922ed3c1816ffff870ea807b853dd"><link rel="stylesheet" href="https://korgano.github.io/assets/css/photoswipe.css?v=da6e9be0fa855edd3610e97c1d4e38d9"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://korgano.github.io/cybersecurity-project-transparent-filtering-bridge-extras-90/"},"headline":"CyberSecurity Project: Transparent Filtering Bridge (+ Extras) 9.0","datePublished":"2025-07-15T10:03-04:00","dateModified":"2025-07-16T07:45-04:00","image":{"@type":"ImageObject","url":"https://korgano.github.io/media/posts/42/cyber-proj-tfb15.png","height":921,"width":1920},"description":"Xavier Santana conducts cybersecurity analysis of data gathered by transparent filtering bridge on his home network, discovering malicious Chinese activity.","author":{"@type":"Person","name":"Xavier Santana","url":"https://korgano.github.io/authors/xavier-santana/"},"publisher":{"@type":"Organization","name":"Xavier Santana"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="post-template lines"><div class="container lines lines--right"><header class="header"><a href="https://korgano.github.io/" class="logo">XS Tech Thoughts</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu">Menu</button><ul class="navbar__menu"><li><a href="https://korgano.github.io/" title="Home" target="_self">Home</a></li><li><a href="https://korgano.github.io/tags/uxui-case-study/" title="UX/UI Case Studies" target="_blank">UX/UI Case Studies</a></li><li><a href="https://korgano.github.io/tags/cybersecurity-projects/" title="Cybersecurity Projects" target="_blank">Cybersecurity Projects</a></li><li><a href="https://korgano.github.io/tags/quick-thoughts/" title="Quick Thoughts" target="_self">Quick Thoughts</a></li><li><a href="https://korgano.github.io/about-me/" title="About Me" target="_blank">About Me</a></li></ul></nav></header><main class="main post"><article class="content"><header class="content__inner content__header"><h1 class="content__title">CyberSecurity Project: Transparent Filtering Bridge (+ Extras) 9.0</h1><div class="content__meta"><div class="content__meta__left"><a href="https://korgano.github.io/authors/xavier-santana/" class="invert content__author" rel="author" title="Xavier Santana">Xavier Santana</a></div><div class="content__meta__right"><time datetime="2025-07-15T10:03" class="content__date">July 15, 2025</time><div class="content__updated">Updated on <time datetime="2025-07-15T10:03" class="content__date">July 16, 2025</time></div></div></div></header><figure class="content__featured-image"><div class="content__featured-image__inner is-img-loading"><img src="https://korgano.github.io/media/posts/42/cyber-proj-tfb15.png" srcset="https://korgano.github.io/media/posts/42/responsive/cyber-proj-tfb15-xs.png 384w, https://korgano.github.io/media/posts/42/responsive/cyber-proj-tfb15-sm.png 600w, https://korgano.github.io/media/posts/42/responsive/cyber-proj-tfb15-md.png 768w, https://korgano.github.io/media/posts/42/responsive/cyber-proj-tfb15-lg.png 1200w, https://korgano.github.io/media/posts/42/responsive/cyber-proj-tfb15-xl.png 1600w" sizes="(min-width: 37.5em) 1600px, 80vw" loading="eager" height="921" width="1920" alt="OPNSense NTP Denial of Service Scan Detection"></div></figure><div class="content__inner"><div class="content__entry"><p>It's been a bit over two weeks, so it's time to check in on the Transparent Filtering Bridge. Having gotten the hardware to <strong>finally </strong>have a functioning management connection, I left the device to do its job, filtering traffic as it passed between the modem and primary router of my mesh network. With a mixture of firewall and Suricata rules in place, what I'm primarily looking for is what, if any, rules have been triggered.</p><div class="post__toc"><h3>Table of Contents</h3><ul><li><a href="#mcetoc_1j078l7n11a">For Some Reason, Config Changes</a></li><li><a href="#mcetoc_1j0842akm15q">Tweaking the Cron Job Timer</a></li><li><a href="#mcetoc_1j0842akm15r">Checking the Firewall Logs</a></li><li><a href="#mcetoc_1j0842akm15s">Filtering Out the Noise</a></li><li><a href="#mcetoc_1j0842akm15t">Checking Up On Suricata</a></li><li><a href="#mcetoc_1j0842akm15u">What To Do Next</a></li><li><a href="#mcetoc_1j0842akm15v">Takeaways</a></li></ul></div><h2 id="mcetoc_1j078l7n11a">For Some Reason, Config Changes</h2><p>One thing that happened between the last entry and now was an automatic Windows update, which closed out my browser, where I had the OPNSense webGUI tab open. This seemed to be helping maintain the connection to device, which would sometimes intermittently fail. I also had a cron job set to reset the interface every 6 hours to address the issue.</p><p>However, when I tried accessing OPNSense webGUI to start this article, I got connection errors.</p><p>So I connected a keyboard and mouse to the miniPC, turned on the monitor, and saw that there was no IP address on the console. Attempting to reset the services wound up freezing on the OPT1 interface (the WiFi), so I cancelled out of that. Then I restarted the miniPC, which brought the IP address back to the interface, but no actual web connectivity.</p><p>This meant it was time to dig into the <code>/usr/local/etc/rc.d/wpa_supplicant</code> file again, which is where I made an interesting discovery. At some point, for some reason, changes had been made to the file. My best guess was that this occurred after the installation of the WiFi firmware, but it's unclear why that would change some comment lines and strip the <code>rcvar</code> value.</p><p>Since the <code>rcvar</code> was what told the machine to enable the WiFi authentication, this explained the WiFi connection issues.</p><p>After making minimal changes to the file (returning the comment values to their original values and fixing the missing <code>rcvar</code> value), I reset the WiFi service and regained connectivity.</p><h2 id="mcetoc_1j0842akm15q">Tweaking the Cron Job Timer</h2><p>Due to the unusual nature of the <code>wpa_supplicant</code> file changes, I decided to reduce the time gap between WiFi interface resets from 6 hours to 4. This would give me more opportunities to retain or regain WiFi access should connection issues continue.</p><p>Not even an hour after I got access back, the WiFi connection went down, which proved this was a smart decision.</p><p>In a major irritation, the WiFi connection seemed to be failing silently a few minutes after being reset, making it hard to interact with the webGUI. In a bizarre situation, I managed to access a specific page of the webGUI, despite not being able to reach the webGUI in general. Even more annoying was the fact that I managed to randomly get access by refreshing the tabs for the webGUI.</p><p>More experimentation (and possibly FreeBSD kernel updates) is clearly needed to resolve this issue.</p><h2 id="mcetoc_1j0842akm15r">Checking the Firewall Logs</h2><p>After updating the cron job configuration, the first thing I did was check the firewall logs.</p><p>One of the more irritating aspects of OPNSense is that <strong>all </strong>firewall logs seem to be seem priority level - Informational. This means that any rule that passes or blocks traffic generates a log in that same level, meaning it is <strong>very </strong>easy to get lost in all the data. Luckily, the provided search option is quite effective - it was easy to get just the logs of blocked connections on the bridge interface.</p><p>(Incidentally, it seems logical to me that someone running a firewall would put logging of blocked traffic at a higher log level.)</p><p>Since these logs were all in a machine readable format that I had no experience with, I decided to download a 50 entry log for analysis with ChatGPT and other tools. The first thing I did was sanitize any of my personal IP addresses.</p><p>Here is an example of a block coming in:</p><p><code>2025-06-17T09:58:31-04:00    Informational    filterlog     2,,,02f4bab031b57d1e30553ce08e0ec131,bridge0,match,block,in,4,0x0,,238,27873,0,DF,6,tcp,71,3.77.205.84,Home IP,443,52742,31,PA,4127654128:4127654159,2661296198,118,,</code></p><p>For contrast, a block going out:</p><p><code>2025-06-25T11:06:30-04:00    Informational    filterlog     68,,,ff197ebab7ec0da7fe008f0f6ffee42b,bridge0,match,block,out,4,0x0,,127,21852,0,DF,6,tcp,52,Home IP,1.1.1.1,21124,443,0,S,2052234833,,64240,,mss;nop;wscale;nop;nop;sackOK</code></p><p>The bits and pieces that I can read without assistance is mostly the interface information, the fact that the rule matched, the action taken, direction of the traffic, protocol, port, and IP addresses.</p><p>Annoyingly, there's no way to get a simplified view that includes the rule name/description, which would make identifying what is going on much easier.</p><p>To figure out what the logs are truly saying, I provided ChatGPT with the above entries and the following query:</p><blockquote><p>In plain english, explain the OPNSense firewall log format based on these two example entries:</p></blockquote><p>ChatGPT's response was as follows, omitting the Timestamp, Severity, and Process information:</p><blockquote><p data-start="251" data-end="387">Following that, the comma‑separated values represent fields defined by pf’s raw filter log format <span data-state="closed"><span class="ms-1 inline-flex max-w-full items-center relative top-[-0.094rem] animate-[show_150ms_ease-in]"><a href="https://docs.netgate.com/pfsense/en/latest/monitoring/logs/raw-filter-format.html" target="_blank" rel="noopener" alt="https://docs.netgate.com/pfsense/en/latest/monitoring/logs/raw-filter-format.html" class="flex h-4.5 overflow-hidden rounded-xl px-2 text-[9px] font-medium text-token-text-secondary! bg-[#F4F4F4]! dark:bg-[#303030]! transition-colors duration-150 ease-in-out"><span class="relative start-0 bottom-0 flex h-full w-full items-center"><span class="flex h-4 w-full items-center justify-between overflow-hidden"><span class="max-w-full grow truncate overflow-hidden text-center">Netgate Documentation</span></span></span></a></span></span>:</p><ol data-start="389" data-end="2502"><li data-start="389" data-end="468"><p data-start="392" data-end="468"><strong data-start="392" data-end="407">Rule Number</strong> (<code data-start="409" data-end="412">2</code> / <code data-start="415" data-end="419">68</code>): The index of the firewall rule that matched.</p></li><li data-start="469" data-end="546"><p data-start="472" data-end="546"><strong data-start="472" data-end="491">Sub‑rule Number</strong> (blank): Secondary rule index if using nested rules.</p></li><li data-start="547" data-end="622"><p data-start="550" data-end="622"><strong data-start="550" data-end="560">Anchor</strong> (blank): Name of the anchor (rule set) containing the rule.</p></li><li data-start="623" data-end="700"><p data-start="626" data-end="700"><strong data-start="626" data-end="640">Tracker ID</strong> (<code data-start="642" data-end="651">02f4ba…</code> / <code data-start="654" data-end="663">ff197e…</code>): Unique flow‑tracking identifier.</p></li><li data-start="701" data-end="788"><p data-start="704" data-end="788"><strong data-start="704" data-end="722">Real Interface</strong> (<code data-start="724" data-end="733">bridge0</code>): The actual network interface the packet traversed.</p></li><li data-start="789" data-end="854"><p data-start="792" data-end="854"><strong data-start="792" data-end="802">Reason</strong> (<code data-start="804" data-end="811">match</code>): Why it was logged (typically <code data-start="843" data-end="850">match</code>).</p></li><li data-start="855" data-end="924"><p data-start="858" data-end="924"><strong data-start="858" data-end="868">Action</strong> (<code data-start="870" data-end="877">block</code>): What the firewall did (<code data-start="903" data-end="909">pass</code> or <code data-start="913" data-end="920">block</code>).</p></li><li data-start="925" data-end="1004"><p data-start="928" data-end="1004"><strong data-start="928" data-end="941">Direction</strong> (<code data-start="943" data-end="947">in</code> / <code data-start="950" data-end="955">out</code>): Traffic direction relative to the interface.</p></li><li data-start="1005" data-end="1071"><p data-start="1008" data-end="1071"><strong data-start="1008" data-end="1022">IP Version</strong> (<code data-start="1024" data-end="1027">4</code>): Internet Protocol version (<code data-start="1057" data-end="1060">4</code> or <code data-start="1064" data-end="1067">6</code>).</p></li><li data-start="1072" data-end="1135"><p data-start="1076" data-end="1135"><strong data-start="1076" data-end="1083">TOS</strong> (<code data-start="1085" data-end="1090">0x0</code>): Type‑of‑Service byte from the IP header.</p></li><li data-start="1136" data-end="1197"><p data-start="1140" data-end="1197"><strong data-start="1140" data-end="1147">ECN</strong> (blank): Explicit Congestion Notification bits.</p></li><li data-start="1198" data-end="1269"><p data-start="1202" data-end="1269"><strong data-start="1202" data-end="1209">TTL</strong> (<code data-start="1211" data-end="1216">238</code> / <code data-start="1219" data-end="1224">127</code>): Time‑to‑Live (IPv4) or Hop Limit (IPv6).</p></li><li data-start="1270" data-end="1336"><p data-start="1274" data-end="1336"><strong data-start="1274" data-end="1283">IP ID</strong> (<code data-start="1285" data-end="1292">27873</code> / <code data-start="1295" data-end="1302">21852</code>): Packet identification number.</p></li><li data-start="1337" data-end="1404"><p data-start="1341" data-end="1404"><strong data-start="1341" data-end="1360">Fragment Offset</strong> (<code data-start="1362" data-end="1365">0</code>): Position within fragmented packet.</p></li><li data-start="1405" data-end="1479"><p data-start="1409" data-end="1479"><strong data-start="1409" data-end="1421">IP Flags</strong> (<code data-start="1423" data-end="1427">DF</code>): IP fragmentation flags (<code data-start="1454" data-end="1458">DF</code>, <code data-start="1460" data-end="1464">MF</code>, or <code data-start="1469" data-end="1475">none</code>).</p></li><li data-start="1480" data-end="1563"><p data-start="1484" data-end="1563"><strong data-start="1484" data-end="1499">Protocol ID</strong> (<code data-start="1501" data-end="1504">6</code>): Numeric protocol identifier (e.g., <code data-start="1542" data-end="1545">6</code>=TCP, <code data-start="1551" data-end="1555">17</code>=UDP).</p></li><li data-start="1564" data-end="1626"><p data-start="1568" data-end="1626"><strong data-start="1568" data-end="1585">Protocol Text</strong> (<code data-start="1587" data-end="1592">tcp</code>): Human‑readable protocol name.</p></li><li data-start="1627" data-end="1694"><p data-start="1631" data-end="1694"><strong data-start="1631" data-end="1648">Packet Length</strong> (<code data-start="1650" data-end="1654">71</code> / <code data-start="1657" data-end="1661">52</code>): Total size of the IP packet.</p></li><li data-start="1695" data-end="1767"><p data-start="1699" data-end="1767"><strong data-start="1699" data-end="1712">Source IP</strong> (<code data-start="1714" data-end="1727">3.77.205.84</code> / <code data-start="1730" data-end="1739">Home IP</code>): Originating IP address.</p></li><li data-start="1768" data-end="1836"><p data-start="1772" data-end="1836"><strong data-start="1772" data-end="1790">Destination IP</strong> (<code data-start="1792" data-end="1801">Home IP</code> / <code data-start="1804" data-end="1813">1.1.1.1</code>): Target IP address.</p></li><li data-start="1837" data-end="1909"><p data-start="1841" data-end="1909"><strong data-start="1841" data-end="1856">Source Port</strong> (<code data-start="1858" data-end="1863">443</code> / <code data-start="1866" data-end="1873">21124</code>): Originating port (for TCP/UDP).</p></li><li data-start="1910" data-end="1982"><p data-start="1914" data-end="1982"><strong data-start="1914" data-end="1934">Destination Port</strong> (<code data-start="1936" data-end="1943">52742</code> / <code data-start="1946" data-end="1951">443</code>): Target port (for TCP/UDP).</p></li><li data-start="1983" data-end="2052"><p data-start="1987" data-end="2052"><strong data-start="1987" data-end="2002">Data Length</strong> (<code data-start="2004" data-end="2008">31</code> / <code data-start="2011" data-end="2014">0</code>): Payload size (excluding headers).</p></li><li data-start="2053" data-end="2128"><p data-start="2057" data-end="2128"><strong data-start="2057" data-end="2070">TCP Flags</strong> (<code data-start="2072" data-end="2076">PA</code> / <code data-start="2079" data-end="2082">S</code>): TCP control flags (e.g., <code data-start="2110" data-end="2113">S</code>, <code data-start="2115" data-end="2119">PA</code>, <code data-start="2121" data-end="2124" data-is-only-node="">F</code>).</p></li><li data-start="2129" data-end="2199"><p data-start="2133" data-end="2199"><strong data-start="2133" data-end="2152">Sequence Number</strong> (<code data-start="2154" data-end="2166">4127654128</code> / <code data-start="2169" data-end="2181">2052234833</code>): TCP sequence.</p></li><li data-start="2200" data-end="2275"><p data-start="2204" data-end="2275"><strong data-start="2204" data-end="2229">Acknowledgment Number</strong> (<code data-start="2231" data-end="2243">4127654159</code> / blank): TCP acknowledgment.</p></li><li data-start="2276" data-end="2343"><p data-start="2280" data-end="2343"><strong data-start="2280" data-end="2295">Window Size</strong> (<code data-start="2297" data-end="2309">2661296198</code> / <code data-start="2312" data-end="2319">64240</code>): TCP receive window.</p></li><li data-start="2344" data-end="2413"><p data-start="2348" data-end="2413"><strong data-start="2348" data-end="2366">Urgent Pointer</strong> (<code data-start="2368" data-end="2373">118</code> / blank): Urgent data pointer if set.</p></li><li data-start="2414" data-end="2502"><p data-start="2418" data-end="2502"><strong data-start="2418" data-end="2433">TCP Options</strong> (blank / <code data-start="2443" data-end="2474">mss;nop;wscale;nop;nop;sackOK</code>): Negotiated TCP options.</p></li></ol><p data-start="2504" data-end="2621">These fields allow you to reconstruct packet details, rule decisions, and flow context directly from the log entries.</p></blockquote><p data-start="2504" data-end="2621">In another showcase of poor UXUI decisions, <a href="https://github.com/opnsense/core/issues/6590#issuecomment-1572679573" title="How to find firewall rule numbers in OPNSense" target="_blank" rel="noopener noreferrer">the way to correlate rules and the rule numbers in webGUI is to access an obscure page</a>, one most users will never think to look at. This is somewhat forgivable due to the numbers themselves being non-permanent assignments, based on the last time the system was rebooted/reloaded. But it is suboptimal UX.</p><div class="gallery-wrapper"><div class="gallery" data-is-empty="false" data-translation="Add images" data-columns="2"><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/42/gallery/cyber-proj-tfb16-2.png" data-size="1920x921"><img loading="lazy" src="https://korgano.github.io/media/posts/42/gallery/cyber-proj-tfb16-2-thumbnail.png" alt="OPNSense Rules part 1" width="768" height="368"></a></figure><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/42/gallery/cyber-proj-tfb17.png" data-size="1920x921"><img loading="lazy" src="https://korgano.github.io/media/posts/42/gallery/cyber-proj-tfb17-thumbnail.png" alt="OPNSense Rules part 2" width="768" height="368"></a></figure><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/42/gallery/cyber-proj-tfb18.png" data-size="1920x921"><img loading="lazy" src="https://korgano.github.io/media/posts/42/gallery/cyber-proj-tfb18-thumbnail.png" alt="OPNSense Rules part 3" width="768" height="368"></a></figure><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/42/gallery/cyber-proj-tfb19.png" data-size="1920x921"><img loading="lazy" src="https://korgano.github.io/media/posts/42/gallery/cyber-proj-tfb19-thumbnail.png" alt="OPNSense Rules part 4" width="768" height="368"></a></figure></div></div><p data-start="2504" data-end="2621">Unfortunately, rule 2 was fairly incomprehensible, likely due to being a default rule: <code>@2 block drop in log inet all label "02f4bab031b57d1e30553ce08e0ec131"</code></p><p data-start="2504" data-end="2621">Rule 68, on the other hand, was <strong>much </strong>more understandable: <code>@68 block drop out log quick on bridge0 inet from any to &lt;Ads_Tracking:843&gt; label "ff197ebab7ec0da7fe008f0f6ffee42b"</code></p><p data-start="2504" data-end="2621">So that outbound connection was a (perceived) attempt to connect to an ad/tracking server, successfully showing that my Aliases and rules do work.</p><h2 id="mcetoc_1j0842akm15s" data-start="2504" data-end="2621">Filtering Out the Noise</h2><p data-start="2504" data-end="2621">Since I wanted to do some amount of inspection of these suspicious IPs, I then needed a way to filter my log for unique IPs. In addition, I would get data on the quantity of those uniques, as well as how many were duplicated.</p><p data-start="2504" data-end="2621">To do this, I would use Microsoft Copilot to generate a PowerShell script to filter the data for me. The prompt was as follows:</p><blockquote><p data-start="2504" data-end="2621">Write me a powershell script that does the following:<br>-reads content of file `filter.log`<br>-reads lines of the following format `2025-06-25T11:06:30-04:00 Informational filterlog 68,,,ff197ebab7ec0da7fe008f0f6ffee42b,bridge0,match,block,out,4,0x0,,127,21852,0,DF,6,tcp,52,Home IP,1.1.1.1,21124,443,0,S,2052234833,,64240,,mss;nop;wscale;nop;nop;sackOK`<br>-counts unique and duplicate IPv4 addresses<br>-identifies unique IPv4 addresses<br>-outputs unique IPv4 address count, duplicate IPv4 address count, and all unique IPv4 addresses to new file `filter-cleaned.log`</p></blockquote><p data-start="2504" data-end="2621">This was the following output:</p><pre class="language-markdown line-numbers"><code># PowerShell Script to Extract and Count IPv4 Addresses

```powershell
# Define input and output files
$inputFile  = 'filter.log'
$outputFile = 'filter-cleaned.log'

# IPv4 regex (0–255 range)
$ipv4Pattern = '\b(?:(?:25[0-5]|2[0-4]\d|[01]?\d?\d)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d?\d)\b'

# Read all lines, extract every IPv4 match
$allIps = Get-Content $inputFile |
    ForEach-Object {
        [regex]::Matches($_, $ipv4Pattern) |
        ForEach-Object { $_.Value }
    }

# Compute counts
$uniqueIps      = $allIps | Sort-Object | Get-Unique
$uniqueCount    = $uniqueIps.Count
$duplicateCount = $allIps.Count - $uniqueCount

# Prepare header lines
$header = @(
    "Unique IPv4 address count: $uniqueCount"
    "Duplicate IPv4 address count: $duplicateCount"
    ""
    "Unique IPv4 addresses:"
)

# Write header and unique IPs to the output file
$header | Set-Content  $outputFile
$uniqueIps | Add-Content $outputFile
```

---

## How This Works

- The script reads every line from `filter.log` and applies a strict IPv4 regex to find address patterns.  
- All matches are collected into `$allIps`, preserving duplicates.  
- Unique addresses are extracted via `Sort-Object | Get-Unique`.  
- Duplicate count is derived by subtracting the number of unique addresses from total matches.  
- Results (counts + list of unique IPs) are written to `filter-cleaned.log`.

---

## Further Enhancements You Might Consider

- If you need the list of IPs that appear more than once, group `$allIps` with `Group-Object` and filter where `.Count -gt 1`.  
- For very large logs, use `Select-String -Pattern $ipv4Pattern -AllMatches` to stream matches rather than loading the entire file at once.  
- Extend the script to handle IPv6 by adding a second regex and interleaving results.  
- Export the results in CSV or JSON for integration with monitoring tools or dashboards.  </code></pre><p>I ran the script and got this confusing result:</p><p><code>Unique IPv4 address count: 877</code><br><code>Duplicate IPv4 address count: 11597</code></p><p>Believing myself to have only gotten a sample size of 50, I began randomly searching the original log file for random IP on the unique list, only to keep finding them. The mystery was answered when I opened the log file in VS Code, revealing that I had dumped the <strong>entire </strong>list of log entries matching the <code>blocked bridge</code> query. I was, in fact, analyzing the full two or so weeks worth of log entries, not just the 50 entries on display in the webGUI.</p><p>To gain more higher level insights, I returned to Copilot and asked it for a new script:</p><blockquote><p>Write me a powershell script that does the following:<br>-reads content of file `filter.log`<br>-reads lines of the following format `2025-06-25T11:06:30-04:00 Informational filterlog 68,,,ff197ebab7ec0da7fe008f0f6ffee42b,bridge0,match,block,out,4,0x0,,127,21852,0,DF,6,tcp,52,Home IP,1.1.1.1,21124,443,0,S,2052234833,,64240,,mss;nop;wscale;nop;nop;sackOK`<br>-counts the number of `in` and `out` entries<br>-generates a count of how many times unique IPv4 addresses appear in the log<br>-Generates a list of how many unique IPv4 addresses are associated with `in` or `out` entries, or both -outputs all data to new file `filter-statistics.log`</p></blockquote><p>Here's what Copilot gave me:</p><pre class="language-markdown line-numbers"><code>```powershell
# PowerShell Script: filter-statistics.ps1
# Reads filter.log, parses “in”/“out” entries and IPv4s, produces filter-statistics.log

# Set input/output paths
$inputFile   = 'filter.log'
$outputFile  = 'filter-statistics.log'

# Initialize counters &amp; storage
$inCount     = 0
$outCount    = 0
$ipStats     = @{}

# Strict IPv4 regex
$ipv4Pattern = '\b(?:(?:25[0-5]|2[0-4]\d|[01]?\d?\d)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d?\d)\b'

# Process each line
Get-Content $inputFile | ForEach-Object {
    $line = $_.Trim()
    if ([string]::IsNullOrWhiteSpace($line)) { return }

    # Split on commas
    $fields = $line -split ','

    # Skip malformed or too-short lines
    if ($fields.Count -lt 20) { return }

    # Extract direction and IP
    $direction = $fields[7].ToLower()
    $ip        = $fields[19].Trim()

    # Validate IPv4 format
    if (-not [regex]::IsMatch($ip, $ipv4Pattern)) { return }

    # Tally global in/out counts
    switch ($direction) {
        'in'  { $inCount++ }
        'out' { $outCount++ }
    }

    # Initialize per-IP record if needed
    if (-not $ipStats.ContainsKey($ip)) {
        $ipStats[$ip] = [PSCustomObject]@{
            Total = 0
            In    = 0
            Out   = 0
        }
    }

    # Update per-IP stats
    $ipStats[$ip].Total++
    if ($direction -eq 'in')  { $ipStats[$ip].In++ }
    if ($direction -eq 'out') { $ipStats[$ip].Out++ }
}

# Compute summary numbers
$uniqueIpCount  = $ipStats.Keys.Count
$onlyInCount    = ($ipStats.GetEnumerator() |
                    Where-Object { $_.Value.In  -gt 0 -and $_.Value.Out -eq 0 }).Count
$onlyOutCount   = ($ipStats.GetEnumerator() |
                    Where-Object { $_.Value.Out -gt 0 -and $_.Value.In  -eq 0 }).Count
$bothCount      = ($ipStats.GetEnumerator() |
                    Where-Object { $_.Value.In  -gt 0 -and $_.Value.Out -gt 0 }).Count

# Build output lines
$output = @()
$output += "Total IN entries: $inCount"
$output += "Total OUT entries: $outCount"
$output += "Unique IPv4 addresses: $uniqueIpCount"
$output += "Unique IPv4 addresses only IN: $onlyInCount"
$output += "Unique IPv4 addresses only OUT: $onlyOutCount"
$output += "Unique IPv4 addresses both IN and OUT: $bothCount"
$output += ''
$output += "IPv4 address frequencies (desc):"

# Append per-IP frequencies
$ipStats.GetEnumerator() |
  Sort-Object { $_.Value.Total } -Descending |
  ForEach-Object { $output += ("{0}: {1}" -f $_.Key, $_.Value.Total) }

# Write everything to the output file
$output | Set-Content $outputFile
```

Save this as `filter-statistics.ps1` in the same folder as your `filter.log` file.  
Run it in PowerShell—after completion, `filter-statistics.log` will contain:

- Total counts of “in” and “out” entries  
- Number of unique IPv4 addresses  
- How many unique addresses appear only in, only out, or in both directions  
- A breakdown of each IPv4 address and how many times it occurs</code></pre><p>The results were mindboggling:</p><p><code>Total IN entries: 10301</code><br><code>Total OUT entries: 108</code><br><code>Unique IPv4 addresses: 643</code><br><code>Unique IPv4 addresses only IN: 641</code><br><code>Unique IPv4 addresses only OUT: 2</code><br><code>Unique IPv4 addresses both IN and OUT: 0</code><br><br><code>IPv4 address frequencies (desc):</code><br><code>216.21.13.15: 840</code><br><code>216.21.13.14: 840</code><br><code>34.107.243.93: 314</code><br><code>52.18.33.33: 242</code><br><code>54.246.231.114: 213</code><br><code>23.197.209.185: 194</code><br><code>23.197.210.93: 167</code><br><code>15.197.177.151: 109</code><br><code>3.33.169.122: 109</code><br><code>67.195.176.151: 108</code><br><code>1.1.1.1: 106</code></p><p>First of all, the 840 entries <strong>each </strong>from <code>216.21.13.15</code> and <code>216.21.13.14</code> were quite alarming. The VirusTotal pages for each IP (<a href="https://www.virustotal.com/gui/ip-address/216.21.13.15/detection" title="216.21.13.15 (216.21.12.0/23) Detection Details" target="_blank" rel="noopener noreferrer">216.21.13.15</a>, <a href="https://www.virustotal.com/gui/ip-address/216.21.13.14" title="216.21.13.14 (216.21.12.0/23) Detection Details" target="_blank" rel="noopener noreferrer">216.21.13.14</a>) made it pretty clear that they were associated with malware. I immediately examined the logs, and saw these connections were blocked on the way in. In fact, the only outbound connections that were blocked were to <code>1.1.1.1</code> and a local network address.</p><p>It's unclear if there's actual malicious traffic coming from Cloudflare (<code>1.1.1.1</code>), or just malware sometimes routing through Cloudflare. Something similar might be happening with <code>34.107.243.93</code>, which is <a href="https://www.virustotal.com/gui/ip-address/34.107.243.93/community" title="Community Commentary on 34.107.243.93 (34.104.0.0/13)" target="_blank" rel="noopener noreferrer">an IP address that seems to be associated with Firefox</a>, but might be used for any number of malicious activities.</p><p>The other addresses are just Amazon or Akami cloud IPs, which means they could be used by anyone for anything at any moment.</p><p>Something that's a bit concerning about these two scripts is the fact that the numbers don't line up, despite them taking in the same log, which was not edited between runs. Despite using the same LLM and same conversation, there was randomness in how it interpreted the results to generate a calculation that was slightly different.</p><h2 id="mcetoc_1j0842akm15t">Checking Up On Suricata</h2><p>After obtaining the log data for the standard firewall, I then proceeded to check the Suricata logs. I didn't expect much from this, because as an IPS, it would really only activate if there was an active threat.</p><p>As it turned out, I was right and wrong. I was correct to assume little would be revealed, but I was wrong in that I <strong>did </strong>have two detections.</p><div class="gallery-wrapper"><div class="gallery" data-is-empty="false" data-translation="Add images" data-columns="2"><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/42/gallery/cyber-proj-tfb14-2.png" data-size="1920x921"><img loading="lazy" src="https://korgano.github.io/media/posts/42/gallery/cyber-proj-tfb14-2-thumbnail.png" alt="OPNSense NTP Denial of Service Scan Detection 1" width="768" height="368"></a></figure><figure class="gallery__item"><a href="https://korgano.github.io/media/posts/42/gallery/cyber-proj-tfb15-2.png" data-size="1920x921"><img loading="lazy" src="https://korgano.github.io/media/posts/42/gallery/cyber-proj-tfb15-2-thumbnail.png" alt="OPNSense NTP Denial of Service Scan Detection 2" width="768" height="368"></a></figure></div></div><p>Curiously, they were both Network Time Protocol DOS scans, which were annoying allowed by Suricata.</p><p><a href="https://www.virustotal.com/gui/ip-address/122.228.23.224/community" title="122.228.23.224 (122.228.0.0/19) Community Assessment" target="_blank" rel="noopener noreferrer">Doing a VirusTotal check revealed that this was an actor from the People's Republic of China</a>, which has done this type of thing for at least a year. Interestingly, one member of the VirusTotal community posted about escalating numbers of scans over a period of months, while I had basically two in a two week span.</p><p>What this really proved was the value of a multi-layered detection setup. The blocking firewall rules clearly did not include this IP address, but if I hadn't had Suricata, I wouldn't have known this even happened. It would be a total false negative, and if for some reason I got hit with a DDoS attack, I would have no warning or idea what was happening.</p><h2 id="mcetoc_1j0842akm15u">What To Do Next</h2><p>Normally, there would be a clear path forward, but there's a few factors that complicate things:</p><ul><li>The inconsistent connectivity makes it hard to update and iterate things in a timely manner.</li><li>Figuring out how to revise the <code>wpa_supplicant</code> file to fix the connectivity issues could take a great deal of time.</li><li>There's a major OPNSense version update scheduled for the end of the month, which may require me to do a <strong>lot </strong>of reconfiguration if I can't simply do an in-place update.</li></ul><p>These all provide incentives to <strong>not </strong>engage in another round of data collection and analysis with the Transparent Filtering Bridge.</p><p>However, due to the fact that I <strong>do </strong>have the log for the period between these latest two posts, I can experiment with various methods for cleaning and analyzing the data while addressing the other issues.</p><h2 id="mcetoc_1j0842akm15v">Takeaways</h2><ul><li>There are FreeBSD/OPNSense processes that can alter the key files and behaviors required for me to maintain a wireless management connection.</li><li>Testing firewall blocking rules aimed at malicious/tracking traffic is more effective over a longer period of time (24+ hours).</li><li>In a Small Office/Home Office environment, Suricata IPS detections may be low/nonexistent, even over a prolonged period of time, depending on your configuration.</li><li>The pfSense firewall log format is quite complex and hard to analyze for humans, but is incredibly information dense and ideal for machine analysis.</li><li>At minimum, in a little over a week and a half, I blocked hundreds of malicious or tracking connection attempts coming into my network, and only two going out.</li><li>In the same time span, I received two NTP scans that might be precursors to DOS attacks from actors in the PRC.</li><li>The NTP scans were not detected by the standard firewall, proving that multi-layer defenses are key to maintaining good cyber hygiene.</li></ul></div><footer class="content__footer"><div class="content__tag-share"><div class="content__tag"><h3 class="content__tag__title">Posted in</h3><ul class="content__tag__list"><li><a href="https://korgano.github.io/tags/cybersecurity/">Cybersecurity</a></li><li><a href="https://korgano.github.io/tags/cybersecurity-projects/">Cybersecurity Projects</a></li><li><a href="https://korgano.github.io/tags/tech/">Tech</a></li><li><a href="https://korgano.github.io/tags/tech-projects/">Tech Projects</a></li></ul></div><div class="content__share"><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fkorgano.github.io%2Fcybersecurity-project-transparent-filtering-bridge-extras-90%2F" class="js-share linkedin" aria-label="Share with LinkedIn" rel="nofollow noopener noreferrer"><svg><use xlink:href="https://korgano.github.io/assets/svg/svg-map.svg#linkedin"/></svg></a></div></div></footer></div></article><div class="content__related"><h3 class="content__related__title">Related posts</h3><div class="l-grid l-grid--2"><article class="c-card"><div class="c-card__wrapper"><figure class="c-card__image is-img-loading"><img src="https://korgano.github.io/media/posts/10/glenn-carstens-peters-npxXWgQ33ZQ-unsplash.jpg" srcset="https://korgano.github.io/media/posts/10/responsive/glenn-carstens-peters-npxXWgQ33ZQ-unsplash-xs.jpg 384w, https://korgano.github.io/media/posts/10/responsive/glenn-carstens-peters-npxXWgQ33ZQ-unsplash-sm.jpg 600w, https://korgano.github.io/media/posts/10/responsive/glenn-carstens-peters-npxXWgQ33ZQ-unsplash-md.jpg 768w, https://korgano.github.io/media/posts/10/responsive/glenn-carstens-peters-npxXWgQ33ZQ-unsplash-lg.jpg 1200w" sizes="(min-width: 37.5em) 80vw, 50vw" loading="lazy" height="2712" width="4076" alt=""></figure><div class="c-card__content"><header><h2 class="c-card__title"><a href="https://korgano.github.io/cybersecurity-project-research-remote-access/" class="invert">Cybersecurity Project Research: Remote Access</a></h2></header><footer class="c-card__meta"><a href="https://korgano.github.io/tags/cybersecurity-projects/" class="c-card__tag">Cybersecurity Projects</a></footer></div></div></article><article class="c-card"><div class="c-card__wrapper"><figure class="c-card__image is-img-loading"><img src="https://korgano.github.io/media/posts/9/andres-urena-vXPXRp_wIg4-unsplash.jpg" srcset="https://korgano.github.io/media/posts/9/responsive/andres-urena-vXPXRp_wIg4-unsplash-xs.jpg 384w, https://korgano.github.io/media/posts/9/responsive/andres-urena-vXPXRp_wIg4-unsplash-sm.jpg 600w, https://korgano.github.io/media/posts/9/responsive/andres-urena-vXPXRp_wIg4-unsplash-md.jpg 768w, https://korgano.github.io/media/posts/9/responsive/andres-urena-vXPXRp_wIg4-unsplash-lg.jpg 1200w" sizes="(min-width: 37.5em) 80vw, 50vw" loading="lazy" height="1687" width="3000" alt=""></figure><div class="c-card__content"><header><h2 class="c-card__title"><a href="https://korgano.github.io/cybersecurity-headache-home-router-uxui/" class="invert">Cybersecurity Headache: Home Router UXUI</a></h2></header><footer class="c-card__meta"><a href="https://korgano.github.io/tags/quick-thoughts/" class="c-card__tag">Quick Thoughts</a></footer></div></div></article></div></div></main><footer class="footer"><div class="footer__left"><div class="footer__copy">Copyright Xavier Santana, 2023-2024. Powered by Publii.</div></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg><use xlink:href="https://korgano.github.io/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = { mobileMenuMode: 'sidebar', animationSpeed: 300, submenuWidth: 'auto', doubleClickTime: 500, mobileMenuExpandableSubmenus: true, relatedContainerForOverlayMenuSelector: '.navbar', };</script><script defer="defer" src="https://korgano.github.io/assets/js/scripts.min.js?v=9c5ab7a87221183f149a42b3cceb7956"></script><script>function publiiDetectLoadedImages () {
         var images = document.querySelectorAll('img[loading]:not(.is-loaded)');
         for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
               images[i].classList.add('is-loaded');
               images[i].parentNode.classList.remove('is-img-loading');
            } else {
               images[i].addEventListener('load', function () {
                  this.classList.add('is-loaded');
                  this.parentNode.classList.remove('is-img-loading');
               }, false);
            }
         }
      }
      publiiDetectLoadedImages();</script><script defer="defer" src="https://korgano.github.io/assets/js/photoswipe.min.js?v=017385b552f7e0d979e2e2fe6f324015"></script><script defer="defer" src="https://korgano.github.io/assets/js/photoswipe-ui-default.min.js?v=d067f0883540b1ddda0e2c9ad1b14260"></script><script>var initPhotoSwipeFromDOM=function(gallerySelector){var parseThumbnailElements=function(el){var thumbElements=el.childNodes,numNodes=thumbElements.length,items=[],figureEl,linkEl,size,item;for(var i=0;i<numNodes;i++){figureEl=thumbElements[i];if(figureEl.nodeType!==1){continue;}
   linkEl=figureEl.children[0];size=linkEl.getAttribute('data-size').split('x');item={src:linkEl.getAttribute('href'),w:parseInt(size[0],10),h:parseInt(size[1],10)};if(figureEl.children.length>1){item.title=figureEl.children[1].innerHTML;}
   if(linkEl.children.length>0){item.msrc=linkEl.children[0].getAttribute('src');}
   item.el=figureEl;items.push(item);}
   return items;};var closest=function closest(el,fn){return el&&(fn(el)?el:closest(el.parentNode,fn));};var onThumbnailsClick=function(e){e=e||window.event;e.preventDefault?e.preventDefault():e.returnValue=false;var eTarget=e.target||e.srcElement;var clickedListItem=closest(eTarget,function(el){return(el.tagName&&el.tagName.toUpperCase()==='FIGURE');});if(!clickedListItem){return;}
   var clickedGallery=clickedListItem.parentNode,childNodes=clickedListItem.parentNode.childNodes,numChildNodes=childNodes.length,nodeIndex=0,index;for(var i=0;i<numChildNodes;i++){if(childNodes[i].nodeType!==1){continue;}
   if(childNodes[i]===clickedListItem){index=nodeIndex;break;}
   nodeIndex++;}
   if(index>=0){openPhotoSwipe(index,clickedGallery);}
   return false;};var photoswipeParseHash=function(){var hash=window.location.hash.substring(1),params={};if(hash.length<5){return params;}
   var vars=hash.split('&');for(var i=0;i<vars.length;i++){if(!vars[i]){continue;}
   var pair=vars[i].split('=');if(pair.length<2){continue;}
   params[pair[0]]=pair[1];}
   if(params.gid){params.gid=parseInt(params.gid,10);}
   return params;};var openPhotoSwipe=function(index,galleryElement,disableAnimation,fromURL){var pswpElement=document.querySelectorAll('.pswp')[0],gallery,options,items;items=parseThumbnailElements(galleryElement);options={galleryUID:galleryElement.getAttribute('data-pswp-uid'),getThumbBoundsFn:function(index){var thumbnail=items[index].el.getElementsByTagName('img')[0],pageYScroll=window.pageYOffset||document.documentElement.scrollTop,rect=thumbnail.getBoundingClientRect();return{x:rect.left,y:rect.top+pageYScroll,w:rect.width};},
   mainClass:'pswp--dark',
   preload: [1,2],
   hideAnimationDuration:200,
   showAnimationDuration:0,
   bgOpacity: 0.7,
   showHideOpacity:true,
   closeOnScroll: true,
   arrowKeys: true,
   closeEl: true,
   captionEl: true,
   fullscreenEl: true,
   zoomEl: true,
   shareEl: true,
   counterEl: true,
   arrowEl: true,
   preloaderEl: true
   };if(fromURL){if(options.galleryPIDs){for(var j=0;j<items.length;j++){if(items[j].pid==index){options.index=j;break;}}}else{options.index=parseInt(index,10)-1;}}else{options.index=parseInt(index,10);}
   if(isNaN(options.index)){return;}
   if(disableAnimation){options.showAnimationDuration=0;}
   gallery=new PhotoSwipe(pswpElement,PhotoSwipeUI_Default,items,options);gallery.init();gallery.options.escKey=true;};var galleryElements=document.querySelectorAll(gallerySelector);for(var i=0,l=galleryElements.length;i<l;i++){galleryElements[i].setAttribute('data-pswp-uid',i+1);galleryElements[i].onclick=onThumbnailsClick;}
   var hashData=photoswipeParseHash();if(hashData.pid&&hashData.gid){openPhotoSwipe(hashData.pid,galleryElements[hashData.gid-1],true,true);}};window.addEventListener('load', function () {initPhotoSwipeFromDOM('.gallery');}, false);</script><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button><button class="pswp__button pswp__button--share" title="Share"></button><button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button><button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button><button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/prism.js"></script><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-line-numbers.min.js"></script><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/clipboard.min.js"></script><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-copy-to-clipboard.min.js"></script><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-inline-color.min.js"></script><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-show-invisibles.min.js"></script><!-- Start main cookie container --><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><!-- Start Banner --><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site, for marketing, and to provide social media functionality. <a href="https://korgano.github.io/privacy-policy/">More details...</a></div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><!-- End of Banner --><!-- Badge --> <button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button><!-- End of Badge --></div><!-- End of main cookie container --><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('🍪 Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('🍪 Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('🍪 Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && (!cbConfig.initialLsState || cbConfig.initialLsState.indexOf(allowedGroup) === -1)) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('🍪 GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('🍪 Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('🍪 Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>