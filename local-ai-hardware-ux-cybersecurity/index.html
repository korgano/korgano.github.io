<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>The UX &amp; Cybersecurity Case for More Local AI Hardware - XS Tech Thoughts</title><meta name="description" content="The UX & Cybersecurity Case for More Local AI Hardware on XS Tech Thoughts by Xavier Santana:
An examination of the UX and Cybersecurity benefits of having local AI hardware in your PC."><meta name="generator" content="Publii Open-Source CMS for Static Site"><!-- Global site tag (gtag.js) - Google Analytics --><script type="gdpr-blocker/Analytics" async src="https://www.googletagmanager.com/gtag/js?id=G-EHLH28GQMY"></script><script type="gdpr-blocker/Analytics">window.dataLayer = window.dataLayer || [];
				  function gtag(){dataLayer.push(arguments);}
				  gtag('js', new Date());
				  gtag('config', 'G-EHLH28GQMY' , { 'anonymize_ip': true });
				  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EHLH28GQMY"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EHLH28GQMY');</script><link rel="canonical" href="https://korgano.github.io/local-ai-hardware-ux-cybersecurity/"><link rel="alternate" type="application/atom+xml" href="https://korgano.github.io/feed.xml"><meta property="og:title" content="The UX & Cybersecurity Case for More Local AI Hardware"><meta property="og:image" content="https://korgano.github.io/media/posts/5/steve-johnson-_0iV9LmPDn0-unsplash.jpg"><meta property="og:image:width" content="5120"><meta property="og:image:height" content="2880"><meta property="og:site_name" content="XS Tech Thoughts"><meta property="og:description" content="The UX & Cybersecurity Case for More Local AI Hardware on XS Tech Thoughts by Xavier Santana:
An examination of the UX and Cybersecurity benefits of having local AI hardware in your PC."><meta property="og:url" content="https://korgano.github.io/local-ai-hardware-ux-cybersecurity/"><meta property="og:type" content="article"><link rel="preload" href="https://korgano.github.io/assets/dynamic/fonts/robotoflex/robotoflex.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="https://korgano.github.io/assets/dynamic/fonts/robotoslab/robotoslab.woff2" as="font" type="font/woff2" crossorigin><link rel="stylesheet" href="https://korgano.github.io/assets/css/style.css?v=722990177922d2ed58f9bd55d273aff7"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://korgano.github.io/local-ai-hardware-ux-cybersecurity/"},"headline":"The UX & Cybersecurity Case for More Local AI Hardware","datePublished":"2023-09-21T11:15","dateModified":"2023-09-24T18:27","image":{"@type":"ImageObject","url":"https://korgano.github.io/media/posts/5/steve-johnson-_0iV9LmPDn0-unsplash.jpg","height":2880,"width":5120},"description":"The UX & Cybersecurity Case for More Local AI Hardware on XS Tech Thoughts by Xavier Santana:\nAn examination of the UX and Cybersecurity benefits of having local AI hardware in your PC.","author":{"@type":"Person","name":"Xavier Santana","url":"https://korgano.github.io/authors/xavier-santana/"},"publisher":{"@type":"Organization","name":"Xavier Santana"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="lines"><div class="container lines lines--right"><header class="header"><a href="https://korgano.github.io/" class="logo">XS Tech Thoughts</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu">Menu</button><ul class="navbar__menu"><li><a href="https://korgano.github.io/" title="Home" target="_self">Home</a></li><li><a href="https://korgano.github.io/tags/uxui-case-study/" title="UX/UI Case Studies" target="_blank">UX/UI Case Studies</a></li><li><a href="https://korgano.github.io/tags/cybersecurity-projects/" title="Cybersecurity Projects" target="_blank">Cybersecurity Projects</a></li><li><a href="https://korgano.github.io/tags/quick-thoughts/" title="Quick Thoughts" target="_self">Quick Thoughts</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__inner post__header"><h1 class="post__title">The UX &amp; Cybersecurity Case for More Local AI Hardware</h1><div class="post__meta"><div class="post__meta__left"><a href="https://korgano.github.io/authors/xavier-santana/" class="invert post__author" rel="author" title="Xavier Santana">Xavier Santana</a></div><div class="post__meta__right"><time datetime="2023-09-21T11:15" class="post__date">September 21, 2023</time><div class="post__updated">Updated on <time datetime="2023-09-21T11:15" class="post__date">September 24, 2023</time></div></div></div></header><figure class="post__featured-image"><div class="post__featured-image__inner is-img-loading"><img src="https://korgano.github.io/media/posts/5/steve-johnson-_0iV9LmPDn0-unsplash.jpg" srcset="https://korgano.github.io/media/posts/5/responsive/steve-johnson-_0iV9LmPDn0-unsplash-xs.jpg 384w, https://korgano.github.io/media/posts/5/responsive/steve-johnson-_0iV9LmPDn0-unsplash-sm.jpg 600w, https://korgano.github.io/media/posts/5/responsive/steve-johnson-_0iV9LmPDn0-unsplash-md.jpg 768w, https://korgano.github.io/media/posts/5/responsive/steve-johnson-_0iV9LmPDn0-unsplash-lg.jpg 1200w, https://korgano.github.io/media/posts/5/responsive/steve-johnson-_0iV9LmPDn0-unsplash-xl.jpg 1600w" sizes="(min-width: 37.5em) 1600px, 80vw" loading="eager" height="2880" width="5120" alt=""></div><figcaption>Photo by Steve Johnson on Unsplash</figcaption></figure><div class="post__inner"><div class="post__entry"><p>Earlier this week, two things crossed my path:</p><ol><li><a href="https://chipsandcheese.com/2023/09/16/hot-chips-2023-amds-phoenix-soc/" title="Hot Chips 2023: AMD’s Phoenix SoC" target="_blank" rel="noopener noreferrer">A fantastic breakdown of AMD's latest laptop processors that feature their XDNA AI engines.</a></li><li>Intel's Innovation Days presentation, which showcased their new processors with local AI hardware (Neural Processing Units - NPUs).</li></ol><p>Both of these are great things in my opinion. Let's get into why.</p><div class="post__toc"><h3>Table of Contents</h3><ul><li><a href="#mcetoc_1hauaonv2121">How Do People Use AI?</a></li><li><a href="#mcetoc_1hauaonv2122">The Cybersecurity Issues</a></li><li><a href="#mcetoc_1hauaonv2123">The UX Issues</a></li><li><a href="#mcetoc_1hauaonv2124">The Two Paths</a></li><li><a href="#mcetoc_1hauaonv2125">Wrap Up</a></li></ul></div><h3 id="mcetoc_1hauaonv2121">How Do People Use AI?</h3><p>The simplest possible explanation of the AI systems in the current zeitgeist is that they are pattern recognition and prediction machines. These Large Language Models (or LLMs) are trained on massive amounts of data. (We won't get into the ethical or artistic issues with this. If you want that, watch the following video:)</p><p class="align-center"></p><div class="post__iframe"><iframe loading="lazy" width="560" height="315" src="https://www.youtube-nocookie.com/embed/-MUEXGaxFDA?si=xcHgi-q_L6R9vt5c" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="allowfullscreen"></iframe></div><p>The user will use some kind of interface - typically text based, but some visual interfaces do exist. The LLM will process the input, figure out the pattern of that input, and then predict the output based on that pattern. (This, incidentally, leads to the "hallucination" problem, where LLM based AI generate stuff that has no actual basis in the prompt or fact.)</p><p>There are two main ways these LLM based AI operate:</p><ol><li>On massive server farms.</li><li>On very expensive graphics cards or special processors.</li></ol><h3 id="mcetoc_1hauaonv2122">The Cybersecurity Issues</h3><p>Like it or not, everyone is going to be using LLM based AI in the near future, because if you know how to use them well, you can get some impressive productivity gains.</p><p>It also doesn't take a genius to recognize the problems here, especially in the context of the CIA triad:</p><ol><li>Confidentiality</li><li>Integrity</li><li>Availability</li></ol><p>Confidentiality, or keeping data out of the hands of anyone who is <strong>not </strong>supposed to have access, runs into a number of problems when you have server based LLMs:</p><ul><li>Can you keep the data confidential if you have to use someone else's LLM servers?</li><li>Can you ensure that the LLM provider isn't going to incorporate the data into their LLM's training model?</li><li>Increased risk of bad actors intercepting data as it moves between the end user PC and the server.</li><li>Leaky or improperly routed VPNs delivering the data to outside actors.</li><li>Increased opportunity for corporate competitors to track your progress by assessing volume of traffic between company PCs and LLM servers.</li></ul><p>And these are just the obvious confidentiality issues that I thought of in five minutes. Things are just as bad when we look at Integrity:</p><ul><li>Data manipulation of the input to the LLM as it travels to the server from the end user.</li><li>Data manipulation of the output from the LLM as it travels from the server to the end user.</li><li>Data corruption due to connection issues between the LLM server and end user.</li><li>Data corruption due to unannounced changes in how the LLM processes data.</li></ul><p>When it comes to availability, we've got a whole new set of problems:</p><ul><li>Stability of connection between the end user and LLM server.</li><li>Availability of LLM server resources.</li><li>Potential DDOS of the LLM server/port.</li><li>Local hardware being expensive and hard to obtain.</li><li>Local hardware availability.</li><li>Local hardware connection issues.</li></ul><h3 id="mcetoc_1hauaonv2123">The UX Issues</h3><p>The UX issues are honestly a near 1:1 overlap with the Cybersecurity ones, plus a few new ones:</p><ul><li>The inconvenience of having to sign up for an account.</li><li>Limited options to customize the interface.</li><li>Limited ability to use LLMs optimized to specific tasks.</li><li>Limited ability to use LLMs with little to no training/output bias.</li><li>Random service issues when LLM load is high.</li></ul><p>Essentially, AI as tool has a lot of hurdles <strong>because </strong>it's not practical to run on a local machine. But what if we could?</p><h3 id="mcetoc_1hauaonv2124">The Two Paths</h3><figure><figure class="post__image post__image--full"><img loading="lazy" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/09/amd_phx_if.jpg?ssl=1" alt="AMD slide showcasing 7040 &quot;Phoenix&quot; Processor, via Chips and Cheese" width="2557" height="1431" data-is-external-image="true"></figure><figcaption>AMD Ryzen 7040 "Phoenix" processor diagram, via Chips and Cheese</figcaption></figure><p>There are two main paths to get more local AI hardware in people's hands. The first is building it into new computer processors, like AMD and Intel are doing. These are focused on "inference," which is just a fancy way of saying "taking input into a trained LLM and generating output."</p><p>(Note: Intel's AI solution is called Neural Processing Units, but I will refer only to AI engines, because it does the same thing and is easier to remember.)</p><p>There are two main ways to do this:</p><ol><li>Devote a small part of the overall processor to AI functions.</li><li>Devote a large part of the overall processor to AI functions.</li></ol><p>Currently, Intel and AMD are releasing products that take the first way to do things. This makes sense from a risk mitigation point of view, but also constitutes a huge bet on the part of the hardware designers. They're not only betting on getting the design right, but that the total performance is going to be good enough for most of the lifespan of the CPU.</p><p>When you're a corporation that can justify replacing entire computers (or just the CPUs, if you're lucky) every 3-4 years, that's an acceptable risk. For an individual or small organization, the upsides are pretty high, but if you rely on AI for a lot of tasks and the programming for LLMs suddenly changes in a way your AI engine/other PC hardware can't handle, you're in a big pickle.</p><p>The other way to do it is to make a big chunk of the CPU an AI engine, like so:</p><figure><figure class="post__image post__image--full"><img loading="lazy" src="https://korgano.github.io/media/posts/5/mlid-june2023-AIE.png" alt="Moore's Law is Dead slide explaining Zen 5 Turin-AI Chiplets." width="1920" height="1055" sizes="(min-width: 37.5em) 1600px, 80vw" srcset="https://korgano.github.io/media/posts/5/responsive/mlid-june2023-AIE-xs.png 384w, https://korgano.github.io/media/posts/5/responsive/mlid-june2023-AIE-sm.png 600w, https://korgano.github.io/media/posts/5/responsive/mlid-june2023-AIE-md.png 768w, https://korgano.github.io/media/posts/5/responsive/mlid-june2023-AIE-lg.png 1200w, https://korgano.github.io/media/posts/5/responsive/mlid-june2023-AIE-xl.png 1600w"></figure><figcaption>Moore's Law is Dead slide explaining Zen 5 Turin-AI performance and configurations.</figcaption></figure><p><a href="https://www.youtube.com/watch?v=QU1DFBtbRWY" title="AMD 12C Zen 5 Strix on AM5: R9 8900G instead of 8900? (+ Turin-AI Update)" target="_blank" rel="noopener noreferrer">According to tech commentary and analysis channel Moore's Law is Dead</a>, AMD has developed a chiplet that provide more than enough performance for any individual's AI tasks.</p><p>For those unfamiliar with how AMD's CPUs are constructed, a chiplet is a small silicon chip with features that would form part of a single larger CPU. So in AMD's case, the actual processor cores are in one or more chiplets, while all the parts that communicate with the rest of the computer are in another. AMD designs its chiplets so that they can work across server, workstation, and desktop PC products.</p><p>With AI hardware in high demand, AMD is certainly going to make AI chiplets for servers. But workstation and desktop are a big question mark, especially since servers get the top tier chiplets. Theoretically, even the worst tier AI engine chiplets would provide excessive amounts of LLM AI task performance for even prosumer users.</p><p>Will AMD make such a CPU? Maybe. Go let AMD's social media accounts know you want that.</p><p>And this leads us to the second path, the M.2 add-on card.</p><p>In case you don't know what an M.2 anything is, here's an example:</p><figure class="post__image"><img loading="lazy" src="https://assetsio.reedpopcdn.com/WD-Black-SN850X-SSD_5rmoNZy.jpg?width=690&amp;quality=80&amp;format=jpg&amp;auto=webp" alt="WD Black SN850X M.2 NVMe SSD" width="690" height="388" data-is-external-image="true"></figure><p>If something the size of a stick of gum that could handle all your AI engine needs sounds attractive, you are not alone. <a href="https://youtu.be/tl1m09ZyfDg?t=2042" title="Meteor Lake Tech Tour Deep Dive" target="null">As it turns out, the company behind Intel's AI engine has actually <strong>made </strong>these devices</a>... they are just being sold to industrial firms. But the fact that they're aware that people want them means there's a chance we can get them down the line.</p><p>What's especially exciting about the idea of an AI engine on an M.2 is the fact that it gives people <strong>options</strong>. It's not a huge component, or something that's going to be stuck under a heat sink/watercooling solution that's a pain to disassemble. You could stick them in any computer with an M.2 drive, even if the performance wouldn't be great for older PCs. You could potentially have two or more side-by-side in a special adapter that would give you tons of AI processing capabilities.</p><p>And this is before we even get into the possibilities of combining the two paths by using <strong>both </strong>CPU integrated and M.2 add-on AI engines.</p><h3 id="mcetoc_1hauaonv2125">Wrap Up</h3><p>To sum it all up, more local AI hardware solves a number of cybersecurity problems:</p><table style="border-collapse: collapse; width: 100%;" border="1"><tbody><tr><td class="align-center" style="width: 33.2853%;"><strong>Confidentiality</strong></td><td class="align-center" style="width: 33.2853%;"><strong>Integrity</strong></td><td class="align-center" style="width: 33.287%;"><strong>Availability</strong></td></tr><tr><td style="width: 33.2853%;">Keeping data confidential.</td><td style="width: 33.2853%;">Data manipulation of LLM input enroute to LLM.</td><td style="width: 33.287%;">Stability of connection between the end user/LLM server.</td></tr><tr><td style="width: 33.2853%;">Risk of LLM developer incorporating confidential data in training model.</td><td style="width: 33.2853%;">Data manipulation of LLM output enroute to end user.</td><td style="width: 33.287%;">Availability of LLM server resources.</td></tr><tr><td style="width: 33.2853%;">Interception of data enroute to LLM.</td><td style="width: 33.2853%;">Data corruption due to issues in LLM/end user connection.</td><td style="width: 33.287%;">Potential DDOS of the LLM server/port.</td></tr><tr><td style="width: 33.2853%;">Improper VPN setups leaking data/delivering data to wrong destination.</td><td style="width: 33.2853%;">Data corruption due to unannounced LLM changes.</td><td style="width: 33.287%;">Local hardware availability.</td></tr><tr><td style="width: 33.2853%;">Less traffic for competitors to analyze.</td><td style="width: 33.2853%;"> </td><td style="width: 33.287%;">Local hardware connection issues.</td></tr></tbody></table><p>It also provides opportunities to solve the following UX problems:</p><ul><li>The inconvenience of having to sign up for an account.</li><li>Limited options to customize the interface.</li><li>Limited ability to use LLMs optimized to specific tasks.</li><li>Limited ability to use LLMs with little to no training/output bias.</li><li>Random service issues when LLM load is high.</li></ul><p>With two main paths to getting more local AI hardware, either as parts of CPUs or in standalone add-on cards, the future looks bright for local AI. But it'll take a decent amount of yelling at the social media clouds to get everyone the hardware they deserve. And without that hardware being available, there's not much incentive or ability to work on the UX problems.</p><p>So let's get that social media campaign going, and </p></div><footer class="post__footer"><div class="post__tag-share"><div class="post__tag"><h3 class="post__tag__title">Posted in</h3><ul class="post__tag__list"><li><a href="https://korgano.github.io/tags/ai/">AI</a></li><li><a href="https://korgano.github.io/tags/cybersecurity/">Cybersecurity</a></li><li><a href="https://korgano.github.io/tags/pc/">PC</a></li><li><a href="https://korgano.github.io/tags/pc-hardware/">PC Hardware</a></li><li><a href="https://korgano.github.io/tags/quick-thoughts/">Quick Thoughts</a></li><li><a href="https://korgano.github.io/tags/tech/">Tech</a></li><li><a href="https://korgano.github.io/tags/ux/">UX</a></li></ul></div><div class="post__share"><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fkorgano.github.io%2Flocal-ai-hardware-ux-cybersecurity%2F" class="js-share linkedin" aria-label="Share with LinkedIn" rel="nofollow noopener noreferrer"><svg><use xlink:href="https://korgano.github.io/assets/svg/svg-map.svg#linkedin"/></svg></a></div></div></footer></div></article></main><footer class="footer"><div class="footer__left"><div class="footer__copy">Copyright Xavier Santana, 2023-2024. Powered by Publii.</div></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg><use xlink:href="https://korgano.github.io/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = { mobileMenuMode: 'sidebar', animationSpeed: 300, submenuWidth: 'auto', doubleClickTime: 500, mobileMenuExpandableSubmenus: true, relatedContainerForOverlayMenuSelector: '.navbar', };</script><script defer="defer" src="https://korgano.github.io/assets/js/scripts.min.js?v=6450cfc483efd7e58ed8ad5b64050d3e"></script><script>function publiiDetectLoadedImages () {
         var images = document.querySelectorAll('img[loading]:not(.is-loaded)');
         for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
               images[i].classList.add('is-loaded');
               images[i].parentNode.classList.remove('is-img-loading');
            } else {
               images[i].addEventListener('load', function () {
                  this.classList.add('is-loaded');
                  this.parentNode.classList.remove('is-img-loading');
               }, false);
            }
         }
      }
      publiiDetectLoadedImages();</script><!-- Start main cookie container --><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><!-- Start Banner --><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site, for marketing, and to provide social media functionality. <a href="https://korgano.github.io/privacy-policy/">More details...</a></div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><!-- End of Banner --><!-- Badge --> <button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button><!-- End of Badge --></div><!-- End of main cookie container --><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('🍪 Config not found, or configuration expired');
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('🍪 Config founded');
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('🍪 Allowed group: ' + allowedGroup);
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('🍪 Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('🍪 Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>