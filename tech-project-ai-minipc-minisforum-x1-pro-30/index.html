<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Tech Project: AI miniPC (Minisforum X1 Pro) 3.0 - XS Tech Thoughts</title><meta name="description" content="Xavier Santana of XS Tech Thoughts experiments with NPU AI inferencing, as well as Qwen3 finetunes for story generation."><meta name="generator" content="Publii Open-Source CMS for Static Site"><!-- Global site tag (gtag.js) - Google Analytics --><script type="gdpr-blocker/Analytics" async src="https://www.googletagmanager.com/gtag/js?id=G-EHLH28GQMY"></script><script type="gdpr-blocker/Analytics">window.dataLayer = window.dataLayer || [];
				  function gtag(){dataLayer.push(arguments);}
				  gtag('js', new Date());
				  gtag('config', 'G-EHLH28GQMY' , { 'anonymize_ip': true });
				  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EHLH28GQMY"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EHLH28GQMY');</script><link rel="stylesheet" href="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-black.css"><link rel="stylesheet" href="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-inline-color.css"><link rel="canonical" href="https://korgano.github.io/tech-project-ai-minipc-minisforum-x1-pro-30/"><link rel="alternate" type="application/atom+xml" href="https://korgano.github.io/feed.xml" title="XS Tech Thoughts - RSS"><meta property="og:title" content="Tech Project: AI miniPC (Minisforum X1 Pro) 3.0"><meta property="og:image" content="https://korgano.github.io/media/posts/48/minipc-034-2.png"><meta property="og:image:width" content="926"><meta property="og:image:height" content="708"><meta property="og:site_name" content="XS Tech Thoughts"><meta property="og:description" content="Xavier Santana of XS Tech Thoughts experiments with NPU AI inferencing, as well as Qwen3 finetunes for story generation."><meta property="og:url" content="https://korgano.github.io/tech-project-ai-minipc-minisforum-x1-pro-30/"><meta property="og:type" content="article"><link rel="preload" href="https://korgano.github.io/assets/dynamic/fonts/robotoflex/robotoflex.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="https://korgano.github.io/assets/dynamic/fonts/robotoslab/robotoslab.woff2" as="font" type="font/woff2" crossorigin><link rel="stylesheet" href="https://korgano.github.io/assets/css/style.css?v=253922ed3c1816ffff870ea807b853dd"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://korgano.github.io/tech-project-ai-minipc-minisforum-x1-pro-30/"},"headline":"Tech Project: AI miniPC (Minisforum X1 Pro) 3.0","datePublished":"2025-09-15T12:00-04:00","dateModified":"2025-09-17T15:51-04:00","image":{"@type":"ImageObject","url":"https://korgano.github.io/media/posts/48/minipc-034-2.png","height":708,"width":926},"description":"Xavier Santana of XS Tech Thoughts experiments with NPU AI inferencing, as well as Qwen3 finetunes for story generation.","author":{"@type":"Person","name":"Xavier Santana","url":"https://korgano.github.io/authors/xavier-santana/"},"publisher":{"@type":"Organization","name":"Xavier Santana"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="post-template lines"><div class="container lines lines--right"><header class="header"><a href="https://korgano.github.io/" class="logo">XS Tech Thoughts</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu">Menu</button><ul class="navbar__menu"><li><a href="https://korgano.github.io/" title="Home" target="_self">Home</a></li><li><a href="https://korgano.github.io/tags/uxui-case-study/" title="UX/UI Case Studies" target="_blank">UX/UI Case Studies</a></li><li><a href="https://korgano.github.io/tags/cybersecurity-projects/" title="Cybersecurity Projects" target="_blank">Cybersecurity Projects</a></li><li><a href="https://korgano.github.io/tags/quick-thoughts/" title="Quick Thoughts" target="_self">Quick Thoughts</a></li><li><a href="https://korgano.github.io/about-me/" title="About Me" target="_blank">About Me</a></li></ul></nav></header><main class="main post"><article class="content"><header class="content__inner content__header"><h1 class="content__title">Tech Project: AI miniPC (Minisforum X1 Pro) 3.0</h1><div class="content__meta"><div class="content__meta__left"><a href="https://korgano.github.io/authors/xavier-santana/" class="invert content__author" rel="author" title="Xavier Santana">Xavier Santana</a></div><div class="content__meta__right"><time datetime="2025-09-15T12:00" class="content__date">September 15, 2025</time><div class="content__updated">Updated on <time datetime="2025-09-15T12:00" class="content__date">September 17, 2025</time></div></div></div></header><figure class="content__featured-image"><div class="content__featured-image__inner is-img-loading"><img src="https://korgano.github.io/media/posts/48/minipc-034-2.png" srcset="https://korgano.github.io/media/posts/48/responsive/minipc-034-2-xs.png 384w, https://korgano.github.io/media/posts/48/responsive/minipc-034-2-sm.png 600w, https://korgano.github.io/media/posts/48/responsive/minipc-034-2-md.png 768w, https://korgano.github.io/media/posts/48/responsive/minipc-034-2-lg.png 1200w, https://korgano.github.io/media/posts/48/responsive/minipc-034-2-xl.png 1600w" sizes="(min-width: 37.5em) 1600px, 80vw" loading="eager" height="708" width="926" alt="Mid-NPU only inferencing run, showing sudden drops in NPU utilization."></div></figure><div class="content__inner"><div class="content__entry"><p>Real life likes to throw all sorts of challenges in our way.</p><p>For a good amount of time, I couldn't update the site due to a problem with Publii's Git repo uploading... A setting that I only used because the Publii team announced plans to depreciate Github Pages upload support. Ironically enough, they shelved those plans, but hadn't told the userbase, so I was stuck on the flawed method until I did a big of digging in the Publii Github Repo's Issues sections.</p><p>Then the X1 Pro got stuck in a Bluescreen of Death (BSoD) loop, which forced me to pull the miniPC apart to get to the SSD. Thankfully, the data on the drive was fine, but I decided to completely reinstall Windows 11 Pro.</p><div class="post__toc"><h3>Table of Contents</h3><ul><li><a href="#mcetoc_1j57342re4">Moral of the Story: Use Snappy Driver Installer</a></li><li><a href="#mcetoc_1j5ccdki425">Testing a Hybrid Model</a></li><li><a href="#mcetoc_1j5ccdki426">Qwen3-TNG</a></li></ul></div><h2 id="mcetoc_1j57342re4">Moral of the Story: Use Snappy Driver Installer</h2><p>After backing up the data and reinstalling Windows 11 by wiping the old partition, I decided to do one major change to my process. After installing the WiFi driver, I decided to download Snappy Driver Installer (SDI).</p><p>SDI is a freeware application that downloads selected collections of drivers, curated by the application's developer, and installs them on the target system. This software's existence is basically down to a few things:</p><ol><li>Windows qualified drivers are often months out of date.</li><li>Most hardware vendors don't seem to push all updated drivers to Microsoft for qualification.</li><li>Most people don't know how to dump the specific hardware info required to search for drivers online.</li><li>Hardware vendors often make it hard to find the latest drivers.</li></ol><p>The result of using SDI was roughly 3.3GB of driver pack downloads, which is quite a large amount of data. However, since graphics drivers for AMD systems are roughly a 1GB on their own, this was notÂ <strong>tooÂ </strong>surprising. The drivers automatically installed after this.</p><p>Several days later, after mostly stable performance, I updated to the latest AMD graphics drivers, which included NPU driver updates. My issues went from "the PC cannot sleep with a USB SATA connector plugged in" to a whole host of BSoDs due to issues like DRIVER_POWER_STATE and DPC_WATCHDOG_VIOLATION. This was extra concerning because the latter was what caused me to reinstall Windows, plus I had properly uninstalled my graphics driver with Display Driver Uninstaller before updating.</p><p>Eventually, after attempting to disable Sleep through Registry edits and PowerShell commands, I downloaded the WinDBG tool, as Windows Event Viewer indicated there were crash logs to examine. Using the tool, I was able to discover the following data:</p><pre class="language-clike line-numbers"><code>*******************************************************************************
*                                                                             *
*                        Bugcheck Analysis                                    *
*                                                                             *
*******************************************************************************

DRIVER_POWER_STATE_FAILURE (9f)
A driver has failed to complete a power IRP within a specific time.
Arguments:
Arg1: 0000000000000003, A device object has been blocking an IRP for too long a time
Arg2: ffffd606cf659060, Physical Device Object of the stack
Arg3: ffffb3842678f000, nt!TRIAGE_9F_POWER on Win7 and higher, otherwise the Functional Device Object of the stack
Arg4: ffffd606febbecf0, The blocked IRP

Debugging Details:
------------------

KEY_VALUES_STRING: 1

    Key  : Analysis.CPU.mSec
    Value: 1968

    Key  : Analysis.Elapsed.mSec
    Value: 15178

    Key  : Analysis.IO.Other.Mb
    Value: 0

    Key  : Analysis.IO.Read.Mb
    Value: 1

    Key  : Analysis.IO.Write.Mb
    Value: 50

    Key  : Analysis.Init.CPU.mSec
    Value: 4796

    Key  : Analysis.Init.Elapsed.mSec
    Value: 134050

    Key  : Analysis.Memory.CommitPeak.Mb
    Value: 118

    Key  : Analysis.Version.DbgEng
    Value: 10.0.27871.1001

    Key  : Analysis.Version.Description
    Value: 10.2505.01.02 amd64fre

    Key  : Analysis.Version.Ext
    Value: 1.2505.1.2

    Key  : Bugcheck.Code.LegacyAPI
    Value: 0x9f

    Key  : Bugcheck.Code.TargetModel
    Value: 0x9f

    Key  : Dump.Attributes.AsUlong
    Value: 0x21808

    Key  : Dump.Attributes.DiagDataWrittenToHeader
    Value: 1

    Key  : Dump.Attributes.ErrorCode
    Value: 0x0

    Key  : Dump.Attributes.KernelGeneratedTriageDump
    Value: 1

    Key  : Dump.Attributes.LastLine
    Value: Dump completed successfully.

    Key  : Dump.Attributes.ProgressPercentage
    Value: 0

    Key  : Failure.Bucket
    Value: 0x9F_3_amdhdaudbus_IMAGE_pci.sys

    Key  : Failure.Hash
    Value: {db5298f0-84e4-933f-a991-f2a6273df4be}

    Key  : Hypervisor.Enlightenments.ValueHex
    Value: 0x7497cf94

    Key  : Hypervisor.Flags.AnyHypervisorPresent
    Value: 1

    Key  : Hypervisor.Flags.ApicEnlightened
    Value: 1

    Key  : Hypervisor.Flags.ApicVirtualizationAvailable
    Value: 0

    Key  : Hypervisor.Flags.AsyncMemoryHint
    Value: 0

    Key  : Hypervisor.Flags.CoreSchedulerRequested
    Value: 0

    Key  : Hypervisor.Flags.CpuManager
    Value: 1

    Key  : Hypervisor.Flags.DeprecateAutoEoi
    Value: 0

    Key  : Hypervisor.Flags.DynamicCpuDisabled
    Value: 1

    Key  : Hypervisor.Flags.Epf
    Value: 0

    Key  : Hypervisor.Flags.ExtendedProcessorMasks
    Value: 1

    Key  : Hypervisor.Flags.HardwareMbecAvailable
    Value: 1

    Key  : Hypervisor.Flags.MaxBankNumber
    Value: 0

    Key  : Hypervisor.Flags.MemoryZeroingControl
    Value: 0

    Key  : Hypervisor.Flags.NoExtendedRangeFlush
    Value: 0

    Key  : Hypervisor.Flags.NoNonArchCoreSharing
    Value: 1

    Key  : Hypervisor.Flags.Phase0InitDone
    Value: 1

    Key  : Hypervisor.Flags.PowerSchedulerQos
    Value: 0

    Key  : Hypervisor.Flags.RootScheduler
    Value: 0

    Key  : Hypervisor.Flags.SynicAvailable
    Value: 1

    Key  : Hypervisor.Flags.UseQpcBias
    Value: 0

    Key  : Hypervisor.Flags.Value
    Value: 38408431

    Key  : Hypervisor.Flags.ValueHex
    Value: 0x24a10ef

    Key  : Hypervisor.Flags.VpAssistPage
    Value: 1

    Key  : Hypervisor.Flags.VsmAvailable
    Value: 1

    Key  : Hypervisor.RootFlags.AccessStats
    Value: 1

    Key  : Hypervisor.RootFlags.CrashdumpEnlightened
    Value: 1

    Key  : Hypervisor.RootFlags.CreateVirtualProcessor
    Value: 1

    Key  : Hypervisor.RootFlags.DisableHyperthreading
    Value: 0

    Key  : Hypervisor.RootFlags.HostTimelineSync
    Value: 1

    Key  : Hypervisor.RootFlags.HypervisorDebuggingEnabled
    Value: 0

    Key  : Hypervisor.RootFlags.IsHyperV
    Value: 1

    Key  : Hypervisor.RootFlags.LivedumpEnlightened
    Value: 1

    Key  : Hypervisor.RootFlags.MapDeviceInterrupt
    Value: 1

    Key  : Hypervisor.RootFlags.MceEnlightened
    Value: 1

    Key  : Hypervisor.RootFlags.Nested
    Value: 0

    Key  : Hypervisor.RootFlags.StartLogicalProcessor
    Value: 1

    Key  : Hypervisor.RootFlags.Value
    Value: 1015

    Key  : Hypervisor.RootFlags.ValueHex
    Value: 0x3f7

BUGCHECK_CODE:  9f

BUGCHECK_P1: 3

BUGCHECK_P2: ffffd606cf659060

BUGCHECK_P3: ffffb3842678f000

BUGCHECK_P4: ffffd606febbecf0

FILE_IN_CAB:  091125-28468-01.dmp

TAG_NOT_DEFINED_202b:  *** Unknown TAG in analysis list 202b

DUMP_FILE_ATTRIBUTES: 0x21808
  Kernel Generated Triage Dump

FAULTING_THREAD:  ffffd606c36c0280

DRVPOWERSTATE_SUBCODE:  3

IMAGE_NAME:  pci.sys

MODULE_NAME: pci

FAULTING_MODULE: fffff8005b640000 pci

BLACKBOXBSD: 1 (!blackboxbsd)

BLACKBOXNTFS: 1 (!blackboxntfs)

BLACKBOXPNP: 1 (!blackboxpnp)

BLACKBOXWINLOGON: 1

CUSTOMER_CRASH_COUNT:  1

PROCESS_NAME:  System

STACK_TEXT:  
ffffb384`2678efa8 fffff800`c930e01d     : 00000000`0000009f 00000000`00000003 ffffd606`cf659060 ffffb384`2678f000 : nt!KeBugCheckEx
ffffb384`2678efb0 fffff800`c930de1c     : 00000000`00000001 ffffb384`2678f3e0 00000000`00000000 ffffb384`2678f189 : nt!PopIrpWatchdogBugcheck+0x1f5
ffffb384`2678f090 fffff800`c8fbd4c2     : ffffb481`0fb91180 fffff800`c9126aff ffffb384`2678f3e8 fffff800`c9126a08 : nt!PopIrpWatchdog+0xc
ffffb384`2678f0c0 fffff800`c8fbdda5     : 00000006`e4e5357c 00000000`0000000f 00000006`eb3db122 ffffb481`0fb91180 : nt!KiProcessExpiredTimerList+0x502
ffffb384`2678f1f0 fffff800`c8f4c805     : 00000000`00000000 00000000`00000000 ffffb481`0fb91180 ffffd606`c36c0280 : nt!KiTimerExpiration+0x2b5
ffffb384`2678f330 fffff800`c93e564e     : ffffb481`0fb91180 ffffb481`0fb91180 00000000`00000000 00000000`00000000 : nt!KiRetireDpcList+0xc45
ffffb384`2678f5c0 00000000`00000000     : ffffb384`26790000 ffffb384`26789000 00000000`00000000 00000000`00000000 : nt!KiIdleLoop+0x9e

IMAGE_VERSION:  10.0.26100.4768

STACK_COMMAND: .process /r /p 0xfffff800c9d0ef80; .thread 0xffffd606c36c0280 ; kb

FAILURE_BUCKET_ID:  0x9F_3_amdhdaudbus_IMAGE_pci.sys

OSPLATFORM_TYPE:  x64

OSNAME:  Windows 10

FAILURE_ID_HASH:  {db5298f0-84e4-933f-a991-f2a6273df4be}

Followup:     MachineOwner
---------

11: kd&gt; !analyze -v
*******************************************************************************
*                                                                             *
*                        Bugcheck Analysis                                    *
*                                                                             *
*******************************************************************************

DRIVER_POWER_STATE_FAILURE (9f)
A driver has failed to complete a power IRP within a specific time.
Arguments:
Arg1: 0000000000000003, A device object has been blocking an IRP for too long a time
Arg2: ffffd606cf659060, Physical Device Object of the stack
Arg3: ffffb3842678f000, nt!TRIAGE_9F_POWER on Win7 and higher, otherwise the Functional Device Object of the stack
Arg4: ffffd606febbecf0, The blocked IRP

Debugging Details:
------------------

KEY_VALUES_STRING: 1

    Key  : Analysis.CPU.mSec
    Value: 984

    Key  : Analysis.Elapsed.mSec
    Value: 982

    Key  : Analysis.IO.Other.Mb
    Value: 0

    Key  : Analysis.IO.Read.Mb
    Value: 1

    Key  : Analysis.IO.Write.Mb
    Value: 50

    Key  : Analysis.Init.CPU.mSec
    Value: 6796

    Key  : Analysis.Init.Elapsed.mSec
    Value: 149264

    Key  : Analysis.Memory.CommitPeak.Mb
    Value: 118

    Key  : Analysis.Version.DbgEng
    Value: 10.0.27871.1001

    Key  : Analysis.Version.Description
    Value: 10.2505.01.02 amd64fre

    Key  : Analysis.Version.Ext
    Value: 1.2505.1.2

    Key  : Bugcheck.Code.LegacyAPI
    Value: 0x9f

    Key  : Bugcheck.Code.TargetModel
    Value: 0x9f

    Key  : Dump.Attributes.AsUlong
    Value: 0x21808

    Key  : Dump.Attributes.DiagDataWrittenToHeader
    Value: 1

    Key  : Dump.Attributes.ErrorCode
    Value: 0x0

    Key  : Dump.Attributes.KernelGeneratedTriageDump
    Value: 1

    Key  : Dump.Attributes.LastLine
    Value: Dump completed successfully.

    Key  : Dump.Attributes.ProgressPercentage
    Value: 0

    Key  : Failure.Bucket
    Value: 0x9F_3_amdhdaudbus_IMAGE_pci.sys

    Key  : Failure.Hash
    Value: {db5298f0-84e4-933f-a991-f2a6273df4be}

    Key  : Hypervisor.Enlightenments.ValueHex
    Value: 0x7497cf94

    Key  : Hypervisor.Flags.AnyHypervisorPresent
    Value: 1

    Key  : Hypervisor.Flags.ApicEnlightened
    Value: 1

    Key  : Hypervisor.Flags.ApicVirtualizationAvailable
    Value: 0

    Key  : Hypervisor.Flags.AsyncMemoryHint
    Value: 0

    Key  : Hypervisor.Flags.CoreSchedulerRequested
    Value: 0

    Key  : Hypervisor.Flags.CpuManager
    Value: 1

    Key  : Hypervisor.Flags.DeprecateAutoEoi
    Value: 0

    Key  : Hypervisor.Flags.DynamicCpuDisabled
    Value: 1

    Key  : Hypervisor.Flags.Epf
    Value: 0

    Key  : Hypervisor.Flags.ExtendedProcessorMasks
    Value: 1

    Key  : Hypervisor.Flags.HardwareMbecAvailable
    Value: 1

    Key  : Hypervisor.Flags.MaxBankNumber
    Value: 0

    Key  : Hypervisor.Flags.MemoryZeroingControl
    Value: 0

    Key  : Hypervisor.Flags.NoExtendedRangeFlush
    Value: 0

    Key  : Hypervisor.Flags.NoNonArchCoreSharing
    Value: 1

    Key  : Hypervisor.Flags.Phase0InitDone
    Value: 1

    Key  : Hypervisor.Flags.PowerSchedulerQos
    Value: 0

    Key  : Hypervisor.Flags.RootScheduler
    Value: 0

    Key  : Hypervisor.Flags.SynicAvailable
    Value: 1

    Key  : Hypervisor.Flags.UseQpcBias
    Value: 0

    Key  : Hypervisor.Flags.Value
    Value: 38408431

    Key  : Hypervisor.Flags.ValueHex
    Value: 0x24a10ef

    Key  : Hypervisor.Flags.VpAssistPage
    Value: 1

    Key  : Hypervisor.Flags.VsmAvailable
    Value: 1

    Key  : Hypervisor.RootFlags.AccessStats
    Value: 1

    Key  : Hypervisor.RootFlags.CrashdumpEnlightened
    Value: 1

    Key  : Hypervisor.RootFlags.CreateVirtualProcessor
    Value: 1

    Key  : Hypervisor.RootFlags.DisableHyperthreading
    Value: 0

    Key  : Hypervisor.RootFlags.HostTimelineSync
    Value: 1

    Key  : Hypervisor.RootFlags.HypervisorDebuggingEnabled
    Value: 0

    Key  : Hypervisor.RootFlags.IsHyperV
    Value: 1

    Key  : Hypervisor.RootFlags.LivedumpEnlightened
    Value: 1

    Key  : Hypervisor.RootFlags.MapDeviceInterrupt
    Value: 1

    Key  : Hypervisor.RootFlags.MceEnlightened
    Value: 1

    Key  : Hypervisor.RootFlags.Nested
    Value: 0

    Key  : Hypervisor.RootFlags.StartLogicalProcessor
    Value: 1

    Key  : Hypervisor.RootFlags.Value
    Value: 1015

    Key  : Hypervisor.RootFlags.ValueHex
    Value: 0x3f7

BUGCHECK_CODE:  9f

BUGCHECK_P1: 3

BUGCHECK_P2: ffffd606cf659060

BUGCHECK_P3: ffffb3842678f000

BUGCHECK_P4: ffffd606febbecf0

FILE_IN_CAB:  091125-28468-01.dmp

TAG_NOT_DEFINED_202b:  *** Unknown TAG in analysis list 202b

DUMP_FILE_ATTRIBUTES: 0x21808
  Kernel Generated Triage Dump

FAULTING_THREAD:  ffffd606c36c0280

DRVPOWERSTATE_SUBCODE:  3

IMAGE_NAME:  pci.sys

MODULE_NAME: pci

FAULTING_MODULE: fffff8005b640000 pci

BLACKBOXBSD: 1 (!blackboxbsd)

BLACKBOXNTFS: 1 (!blackboxntfs)

BLACKBOXPNP: 1 (!blackboxpnp)

BLACKBOXWINLOGON: 1

CUSTOMER_CRASH_COUNT:  1

PROCESS_NAME:  System

STACK_TEXT:  
ffffb384`2678efa8 fffff800`c930e01d     : 00000000`0000009f 00000000`00000003 ffffd606`cf659060 ffffb384`2678f000 : nt!KeBugCheckEx
ffffb384`2678efb0 fffff800`c930de1c     : 00000000`00000001 ffffb384`2678f3e0 00000000`00000000 ffffb384`2678f189 : nt!PopIrpWatchdogBugcheck+0x1f5
ffffb384`2678f090 fffff800`c8fbd4c2     : ffffb481`0fb91180 fffff800`c9126aff ffffb384`2678f3e8 fffff800`c9126a08 : nt!PopIrpWatchdog+0xc
ffffb384`2678f0c0 fffff800`c8fbdda5     : 00000006`e4e5357c 00000000`0000000f 00000006`eb3db122 ffffb481`0fb91180 : nt!KiProcessExpiredTimerList+0x502
ffffb384`2678f1f0 fffff800`c8f4c805     : 00000000`00000000 00000000`00000000 ffffb481`0fb91180 ffffd606`c36c0280 : nt!KiTimerExpiration+0x2b5
ffffb384`2678f330 fffff800`c93e564e     : ffffb481`0fb91180 ffffb481`0fb91180 00000000`00000000 00000000`00000000 : nt!KiRetireDpcList+0xc45
ffffb384`2678f5c0 00000000`00000000     : ffffb384`26790000 ffffb384`26789000 00000000`00000000 00000000`00000000 : nt!KiIdleLoop+0x9e


IMAGE_VERSION:  10.0.26100.4768

STACK_COMMAND: .process /r /p 0xfffff800c9d0ef80; .thread 0xffffd606c36c0280 ; kb

FAILURE_BUCKET_ID:  0x9F_3_amdhdaudbus_IMAGE_pci.sys

OSPLATFORM_TYPE:  x64

OSNAME:  Windows 10

FAILURE_ID_HASH:  {db5298f0-84e4-933f-a991-f2a6273df4be}

Followup:     MachineOwner
---------</code></pre><p>As a result, I downloaded Driver Store Explorer and uninstalled the AMD HD Audio driver.</p><p>Curiously, it seems like <a href="https://www.glenn.delahoy.com/community/snappy-driver-installer-origin/sdio-corrupts-my-windows-with-amd-high-definition-audio-controller-driver-install/" title="SDIO corrupts my Windows with AMD High Definition Audio Controller driver install" target="_blank" rel="noopener noreferrer">Snappy Driver Installer might have corrupted the download of the AMD HD Audio Driver</a>, which means said driver might have been missed by Display Driver Uninstaller. Or it could mean there's some kind of issue with installing it on certain systems.</p><h2 id="mcetoc_1j5ccdki425">Testing Hybrid Models</h2><p>One of the purposes of purchasing an HX370 based miniPC was testing NPUs. The first few iterations of Lemonade Server I tried had issues with missing dependencies, but by the time I had to reinstall Windows 11 Pro, those were resolved.Â </p><p>As a handy test, I returned to an older version of prompting for a revised wpa_supplicant script. This was because, at the time, I could not use VS Code POML extension to send the prompt to the LLM. Instead, I chose to use AnythingLLM as the UI, since it would retain a copy of the output.</p><p>I opted to use the provided DeepSeek R1 NPU operation model from AMD, for one simple reason. Converting a model to the ONNX format used by the hybrid and NPU models is incredibly annoying. It not only requires decent hardware to accomplish in the first place, but also requires extra layers of software to configure.</p><figure class="post__image"><img loading="lazy" src="https://korgano.github.io/media/posts/48/minipc-032.png" alt="Start up of load on NPU during prompt execution." width="926" height="708" sizes="(min-width: 37.5em) 1600px, 80vw" srcset="https://korgano.github.io/media/posts/48/responsive/minipc-032-xs.png 384w, https://korgano.github.io/media/posts/48/responsive/minipc-032-sm.png 600w, https://korgano.github.io/media/posts/48/responsive/minipc-032-md.png 768w, https://korgano.github.io/media/posts/48/responsive/minipc-032-lg.png 1200w, https://korgano.github.io/media/posts/48/responsive/minipc-032-xl.png 1600w"></figure><p>Oddly, the NPU's utilization topped out at around 60% of the total compute capacity.</p><figure class="post__image"><img loading="lazy" src="https://korgano.github.io/media/posts/48/minipc-033.png" alt="AnythingLLM during DeepSeek R1 hybrid NPU/GPU test." width="1920" height="1033" sizes="(min-width: 37.5em) 1600px, 80vw" srcset="https://korgano.github.io/media/posts/48/responsive/minipc-033-xs.png 384w, https://korgano.github.io/media/posts/48/responsive/minipc-033-sm.png 600w, https://korgano.github.io/media/posts/48/responsive/minipc-033-md.png 768w, https://korgano.github.io/media/posts/48/responsive/minipc-033-lg.png 1200w, https://korgano.github.io/media/posts/48/responsive/minipc-033-xl.png 1600w"></figure><p>One thing that was surprising was the slow pace of generation in AnythingLLM. While some amount of slowdown in text generation shows up from time to time with GPU LLM tasks, the NPU only run was consistently slow. It would take several seconds to generate a full word.</p><figure class="post__image"><img loading="lazy" src="https://korgano.github.io/media/posts/48/minipc-034.png" alt="Mid-NPU only inferencing run, showing sudden drops in NPU utilization." width="926" height="708" sizes="(min-width: 37.5em) 1600px, 80vw" srcset="https://korgano.github.io/media/posts/48/responsive/minipc-034-xs.png 384w, https://korgano.github.io/media/posts/48/responsive/minipc-034-sm.png 600w, https://korgano.github.io/media/posts/48/responsive/minipc-034-md.png 768w, https://korgano.github.io/media/posts/48/responsive/minipc-034-lg.png 1200w, https://korgano.github.io/media/posts/48/responsive/minipc-034-xl.png 1600w"></figure><p>Also interesting was the NPU utilization, which dropped from 60% to 50% over the course of response generation. Oddly, every so often, there would be a massive dip to 0% utilization, before spiking to a higher level, which may had something to do with how perceptibly slow text generation was.</p><figure class="post__image"><img loading="lazy" src="https://korgano.github.io/media/posts/48/minipc-035.png" alt="NPU and GPU usage at start of prompt response in hybrid mode." width="766" height="583" sizes="(min-width: 37.5em) 1600px, 80vw" srcset="https://korgano.github.io/media/posts/48/responsive/minipc-035-xs.png 384w, https://korgano.github.io/media/posts/48/responsive/minipc-035-sm.png 600w, https://korgano.github.io/media/posts/48/responsive/minipc-035-md.png 768w, https://korgano.github.io/media/posts/48/responsive/minipc-035-lg.png 1200w, https://korgano.github.io/media/posts/48/responsive/minipc-035-xl.png 1600w"></figure><p>Testing the same prompt with a hybrid model (NPU + GPU) operation produced a highly unusual and potentially troubling result. The NPU's utilization briefly spiked very early in the task, before the GPU rose to 90+% utilization.</p><p>According to the <a href="https://lemonade-server.ai/docs/faq/#2-i-loaded-a-hybrid-model-but-the-npu-is-barely-active-is-that-expected" title="Lemonade Server Docs - FAQ Guide" target="_blank" rel="noopener noreferrer">Lemonade Server FAQ</a>, this is expected behavior:</p><blockquote><h4 id="2-i-loaded-a-hybrid-model-but-the-npu-is-barely-active-is-that-expected">2.Â <strong>I loaded a hybrid model, but the NPU is barely active. Is that expected?</strong></h4><p>Yes. In hybrid mode:</p><ul><li>The NPU handles prompt processing.</li><li>The GPU handles token generation.</li><li>If your prompt is short, the NPU finishes quickly. Try a longer prompt to see more NPU activity.</li></ul></blockquote><p>This is problematic for a simple reason: if the NPU is doing one thing really fast during hybrid mode, it has effectively no value, because it's not doing anything through 99.999+% of the run. The HX370 has a theoretical maximum AI performance of 80 TOPS... but that value is based on the combination of NPUÂ <strong>andÂ </strong>GPU.</p><p>If AMD can't fully leverage having an NPUÂ <strong>andÂ </strong>GPU by assigning different parts of the inferencing work to the most capable hardware, there's no real value in having the NPU.</p><p>Perhaps ROCm 7 on Windows will allow better use of the NPU, but at the moment, its only utility is as a method of running LLMs while your GPU is occupied with other work.</p><h2 id="mcetoc_1j5ccdki426">Qwen3-TNG</h2><p>Once I had the initial reinstall complete, I decided to rebuild my set of local AI models after testing the NPU. A number of Qwen3 finetunes from <a href="https://huggingface.co/DavidAU" title="DavidAU HuggingFace Repo" target="_blank" rel="noopener noreferrer">DavidAU</a> released, using scripts from Star Trek episodes to finetune the model. Since I have some casual Star Trek knowledge, I decided to give it a try. I was curious to see what the quality of the results would be, since a Retrieval Augmented Generation (RAG) system could potentially do the same thing.</p><p>Here is the prompt I came up, using a previously created POML template for generating story scenes as a base:</p><pre class="language-html line-numbers"><code>&lt;poml&gt;
&lt;runtime
      temperature="1" 
      maxTokens="0" 
      model="user.Qwen3-TNG"
      topP="0.8" /&gt;
&lt;role&gt;
You are an expert writer, master of all storytelling genres and styles. You double check every word to ensure precision and maximum impact on the reader. You triple check the details of story progression to ensure consistency in the plot, setting, and characters. If you are ever uncertain about something, put it in between #lt; and #gt; to let your editor know it needs examination.
&lt;/role&gt;
&lt;cp caption="Creative Interpretation Guidelines"&gt;
  &lt;list&gt;
    &lt;item&gt;Fill in gaps with imaginative details that align with the foundational elements.&lt;/item&gt;
    &lt;item&gt;Maintain consistency with the established backstory, characters, and overall setting.&lt;/item&gt;
    &lt;item&gt;Write everything in third person perspctive and past tense.&lt;/item&gt;
    &lt;item&gt;Scene length: 500 words.&lt;/item&gt;
  &lt;/list&gt;
&lt;/cp&gt;
&lt;cp caption="Scene Header"&gt;
  &lt;list&gt;
    &lt;item&gt;Scene Title/Identifier: Transporter Room Confrontation&lt;/item&gt;
  &lt;/list&gt;
&lt;/cp&gt;
&lt;cp caption="Characters Present"&gt;
  &lt;list&gt;
    &lt;item&gt;Lieutenant Commander Geordi La Forge&lt;/item&gt;
    &lt;item&gt;Lieutenant Commander Data&lt;/item&gt;
    &lt;item&gt;Lynn Jore, humanoid female&lt;/item&gt;
  &lt;/list&gt;
&lt;/cp&gt;
&lt;cp caption="Specific Location"&gt;
  &lt;list&gt;
    &lt;item&gt;USS Enterprise-D&lt;/item&gt;
    &lt;item&gt;Transporter Room&lt;/item&gt;
  &lt;/list&gt;
&lt;/cp&gt;
&lt;cp caption="Actions and Key Events"&gt;
  &lt;list&gt;
    &lt;item&gt;La Forge and Data race to the transporter room with phasers in hand&lt;/item&gt;
    &lt;item&gt;Lynn Jore is standing on the transporter pad holding a case full of stolen isolinear chips&lt;/item&gt;
    &lt;item&gt;La Forge and Data enter and tell her to put down the case&lt;/item&gt;
    &lt;item&gt;Data informs her the transporter has been disabled&lt;/item&gt;
    &lt;item&gt;La Forge goes to the transporter console and discovers the operator is only unconscious&lt;/item&gt;
    &lt;item&gt;Jore puts down the case and asks how they caught her&lt;/item&gt;
    &lt;item&gt;La Forge taps his comm badge and tells Worf the room is secure&lt;/item&gt;
    &lt;item&gt;Data explains that she used old codes that had been rescinded after Lore posed as Data&lt;/item&gt;
    &lt;item&gt;La Forge asks how Jore could have known those codes&lt;/item&gt;
    &lt;item&gt;Jore smirks at Data and says "Take a guess, &lt;i&gt;brother&lt;/i&gt;"&lt;/item&gt;
    &lt;item&gt;Data and La Forge share a look of disbelief&lt;/item&gt;
  &lt;/list&gt;
&lt;/cp&gt;
&lt;cp caption="Mood and Tone"&gt;
  &lt;list&gt;
    &lt;item&gt;Tense&lt;/item&gt;
    &lt;item&gt;Surreal disbelief when Lynn Jore reveals she is Lore&lt;/item&gt;
  &lt;/list&gt;
&lt;/cp&gt;
&lt;cp caption="Scene Narrative Output Structure"&gt;
  &lt;list&gt;
    &lt;item&gt;Introduce the sceneâ€™s setting and context based on the foundational elements and specific location.&lt;/item&gt;
    &lt;item&gt;Present the characters present and establish their immediate situation.&lt;/item&gt;
    &lt;item&gt;Detail the actions, key events, and unfolding drama within the scene.&lt;/item&gt;
    &lt;item&gt;Conclude with the mood, consequences, or hints at what comes next (especially important for continuation scenes).&lt;/item&gt;
  &lt;/list&gt;
&lt;/cp&gt;
&lt;task&gt;
  Write a scene based on the information in this prompt.
  &lt;list&gt;
    &lt;item&gt;Read Characters Present to determine which characters are in the scene.&lt;/item&gt;
    &lt;item&gt;Read Specific Location to determine where the scene takes place.&lt;/item&gt;
    &lt;item&gt;Read Actions and Key Events to learn what actions, interactions, and scene specific details should exist.&lt;/item&gt;
    &lt;item&gt;Cross reference Characters Present, Specific Location, and Actions and Key Events with the Foundational Information data to generate overall context for the scene.&lt;/item&gt;
    &lt;item&gt;Write out the scene based on the analysis done in the previous steps.&lt;/item&gt;
    &lt;item&gt;Read over the scene to spot any logic flaws, inconsistencies, and/or ambiguiies.&lt;/item&gt;
    &lt;item&gt;Rewrite scene elements as necessary to correct logic flaws or inconsistencies.&lt;/item&gt;
    &lt;item&gt;If any ambiguiies or questions are detected, mark them for editor review.&lt;/item&gt;
    &lt;item&gt;Read over the finalized scene and generate a bullet point event summary to aid in maintaining continuity.&lt;/item&gt;
  &lt;/list&gt;
&lt;/task&gt;
&lt;output-format&gt;Generate the story and event summaries in separate response sections with the following headers: Story, Event Summary&lt;/output-format&gt;
&lt;/poml&gt;</code></pre><p>The statistics on this run were as follows:</p><table style="border-collapse: collapse; width: 100%; height: 123.7px;" border="1"><tbody><tr style="height: 75.35px;"><td style="width: 24.9572%; height: 75.35px;">Input Tokens</td><td style="width: 24.9572%; height: 75.35px;">Output Tokens</td><td style="width: 24.9572%; height: 75.35px;">Time to First Token</td><td style="width: 24.9572%; height: 75.35px;">Tokens per Second</td></tr><tr style="height: 48.35px;"><td style="width: 24.9572%; height: 48.35px;">655</td><td style="width: 24.9572%; height: 48.35px;">1367</td><td style="width: 24.9572%; height: 48.35px;">2.48</td><td style="width: 24.9572%; height: 48.35px;"><span style="color: var(--text-primary-color); font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);">16.56</span></td></tr></tbody></table><p>Interestingly, this model seems to have difficulties generating prose text, tending to generate less detailed and more dialogue heavy text. This is likely due to the <a href="https://huggingface.co/datasets/progs2002/star-trek-tng-scripts" title="Dataset: progs2002/star-trek-tng-scripts" target="_blank" rel="noopener noreferrer">training data set</a>, which consists of <a href="https://www.st-minutiae.com/resources/scripts/#thenextgeneration" title="Star Trek Scripts - Star Trek: The Next Generation" target="_blank" rel="noopener noreferrer">the actual shooting scripts from Star Trek: The Next Generation</a>, which were uploaded to the internet in the late-1990s/early-2000s.</p><p>Here is an example of one:</p><pre class="language-clike line-numbers"><code>1    EXT. SPACE - THE ENTERPRISE (OPTICAL)

	sweeps by majestically at warp. WE CLEARLY SEE THE
	REGISTRY NUMBER on her wing -- ten foot tall navy blue
	letters reading NCC-1701D.

					RIKER (V.O.)
			First officer's log, stardate
			41775.5. We are en route to the
			ocean world known as Pacifica...

2    INT. ENTERPRISE - MAIN BRIDGE - WIDE ANGLE

	The mood is relaxed. RIKER is at Command with TROI
	beside him. WORF'S at Security, DATA and GEORDI at Ops
	and Conn.

					RIKER (V.O.)
				(continuing)
			Our mission is routinely
			scientific in nature. We look
			forward to seeing the warm blue
			waters and fine white beaches that
			make Pacifica a treasured jewel
			of the galaxy.</code></pre><p>And here's a short excerpt from the output:</p><pre class="language-clike line-numbers"><code>"Hands up! Drop the case!" Geordi commands, voice low and dangerous. Jore complies instantly, holding the case out in front of her. Data steps forward, his voice clipped and professional.
"Your transporter is inoperable. We have full control of the system."
Jore smiles, a little too sweetly, but there's no trace of mirth in her eyes.
"Of course you do. You're a clever little cat, aren't you, Commander Data?"
La Forge eyes her warily. He crosses to the console, punches in commands.</code></pre><p>It's clear that the model was heavily skewed towards script style outputs, and also present tense format, despite the prompt deliberately pointing to past tense.</p><p>Experiments with moving the role and creative interpretation elements of the prompt into the system prompt with this and similar models have some effect. But in general, it seems that models trained on scripts or transcripts will stick to that format, versus more broadly trained models, which can be more easily switch between styles.</p><p>That said, for roleplay or script based fanfiction uses, these models seem quite competent within their limitations.</p><h2>Takeaways</h2><ul><li>Use Snappy Driver Installer Origin to update drivers whenever you clean install a new Windows installation.</li><li>Get WinDBG to access Windows crash dumps, in case the crashes are related to drivers.</li><li>NPU only AI inference is slow on AMD APUs, pre-ROCm 7.</li><li>NPU+GPU AI inference on pre-ROCm 7 AMD APUs barely utilizes the NPU.</li><li>Qwen3 models finetuned on scripts or transcripts will tend to generate outputs reflecting the style of the training material (present tense, script style dialogue formatting).</li></ul><p>Data from these tests will be uploaded to my public <a href="https://github.com/korgano/AI_Experiment_Docs" title="Github: AI_Experiment_Docs" target="_blank" rel="noopener noreferrer">AI experiment documentation repo</a>.</p></div><footer class="content__footer"><div class="content__tag-share"><div class="content__tag"><h3 class="content__tag__title">Posted in</h3><ul class="content__tag__list"><li><a href="https://korgano.github.io/tags/ai/">AI</a></li><li><a href="https://korgano.github.io/tags/pc/">PC</a></li><li><a href="https://korgano.github.io/tags/tech/">Tech</a></li><li><a href="https://korgano.github.io/tags/tech-projects/">Tech Projects</a></li></ul></div><div class="content__share"><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fkorgano.github.io%2Ftech-project-ai-minipc-minisforum-x1-pro-30%2F" class="js-share linkedin" aria-label="Share with LinkedIn" rel="nofollow noopener noreferrer"><svg><use xlink:href="https://korgano.github.io/assets/svg/svg-map.svg#linkedin"/></svg></a></div></div></footer></div></article><div class="content__related"><h3 class="content__related__title">Related posts</h3><div class="l-grid l-grid--2"><article class="c-card"><div class="c-card__wrapper"><figure class="c-card__image is-img-loading"><img src="https://korgano.github.io/media/posts/14/EGS-account-pub-serv.PNG" srcset="https://korgano.github.io/media/posts/14/responsive/EGS-account-pub-serv-xs.PNG 384w, https://korgano.github.io/media/posts/14/responsive/EGS-account-pub-serv-sm.PNG 600w, https://korgano.github.io/media/posts/14/responsive/EGS-account-pub-serv-md.PNG 768w, https://korgano.github.io/media/posts/14/responsive/EGS-account-pub-serv-lg.PNG 1200w" sizes="(min-width: 37.5em) 80vw, 50vw" loading="lazy" height="860" width="1600" alt="Wireshark Packet Capture of traffic to domain account-public-service-prod03.ol.epicgames.com"></figure><div class="c-card__content"><header><h2 class="c-card__title"><a href="https://korgano.github.io/cybersecurity-project-epic-games-store-packet-capture-ips-1/" class="invert">Cybersecurity Project: Epic Games Store Packet Capture - IPs 1</a></h2></header><footer class="c-card__meta"><a href="https://korgano.github.io/tags/cybersecurity-projects/" class="c-card__tag">Cybersecurity Projects</a></footer></div></div></article><article class="c-card"><div class="c-card__wrapper"><figure class="c-card__image is-img-loading"><img src="https://korgano.github.io/media/posts/13/suspicious-ip-loc-2.PNG" srcset="https://korgano.github.io/media/posts/13/responsive/suspicious-ip-loc-2-xs.PNG 384w, https://korgano.github.io/media/posts/13/responsive/suspicious-ip-loc-2-sm.PNG 600w, https://korgano.github.io/media/posts/13/responsive/suspicious-ip-loc-2-md.PNG 768w, https://korgano.github.io/media/posts/13/responsive/suspicious-ip-loc-2-lg.PNG 1200w" sizes="(min-width: 37.5em) 80vw, 50vw" loading="lazy" height="827" width="1600" alt="The most suspicious possible IP address location - the middle of a reservoir in Kansas."></figure><div class="c-card__content"><header><h2 class="c-card__title"><a href="https://korgano.github.io/cybersecurity-project-epic-games-store-packet-capture-ip-addresses/" class="invert">Cybersecurity Project: Epic Games Store Packet Capture - Domains</a></h2></header><footer class="c-card__meta"><a href="https://korgano.github.io/tags/cybersecurity-projects/" class="c-card__tag">Cybersecurity Projects</a></footer></div></div></article></div></div></main><footer class="footer"><div class="footer__left"><div class="footer__copy">Copyright Xavier Santana, 2023-2025. Powered by Publii.</div></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg><use xlink:href="https://korgano.github.io/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = { mobileMenuMode: 'sidebar', animationSpeed: 300, submenuWidth: 'auto', doubleClickTime: 500, mobileMenuExpandableSubmenus: true, relatedContainerForOverlayMenuSelector: '.navbar', };</script><script defer="defer" src="https://korgano.github.io/assets/js/scripts.min.js?v=9c5ab7a87221183f149a42b3cceb7956"></script><script>function publiiDetectLoadedImages () {
         var images = document.querySelectorAll('img[loading]:not(.is-loaded)');
         for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
               images[i].classList.add('is-loaded');
               images[i].parentNode.classList.remove('is-img-loading');
            } else {
               images[i].addEventListener('load', function () {
                  this.classList.add('is-loaded');
                  this.parentNode.classList.remove('is-img-loading');
               }, false);
            }
         }
      }
      publiiDetectLoadedImages();</script><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/prism.js"></script><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-line-numbers.min.js"></script><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/clipboard.min.js"></script><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-copy-to-clipboard.min.js"></script><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-inline-color.min.js"></script><script defer="defer" src="https://korgano.github.io/media/plugins/syntaxHighlighter/prism-show-invisibles.min.js"></script><!-- Start main cookie container --><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><!-- Start Banner --><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site, for marketing, and to provide social media functionality. <a href="https://korgano.github.io/privacy-policy/">More details...</a></div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><!-- End of Banner --><!-- Badge --> <button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button><!-- End of Badge --></div><!-- End of main cookie container --><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('ðŸª Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('ðŸª GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('ðŸª Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('ðŸª GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('ðŸª Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && (!cbConfig.initialLsState || cbConfig.initialLsState.indexOf(allowedGroup) === -1)) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('ðŸª GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('ðŸª Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('ðŸª Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('ðŸª Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('ðŸª Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>